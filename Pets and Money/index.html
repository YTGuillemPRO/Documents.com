<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pet Clicker Premium - Sistema de Persistencia Firebase</title>
    <style>
        /* RESETEO DE ESTILOS BASE 
           Aseguramos que el juego se vea igual en todos los navegadores
        */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* FONDO ANIMADO Y CONTENEDOR 
           Usamos un gradiente de 45 grados para un look moderno
        */
        body {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            overflow: hidden;
            color: #333;
        }

        /* EL FRAME PRINCIPAL (Nuestra ScreenGui) 
           Dise√±o estilo m√≥vil pero adaptable a PC
        */
        #game-frame {
            width: 400px;
            height: 700px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            position: relative;
            display: flex;
            flex-direction: column;
            border: 5px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }

        header h1 {
            font-size: 26px;
            font-weight: 900;
            color: #2d3436;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
        }

        /* SISTEMA DE PESTA√ëAS (TABS) 
        */
        .tab-system {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 15px;
            background: #dfe6e9;
            color: #636e72;
            font-weight: 800;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn.active {
            background: #4caf50;
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            transform: translateY(-2px);
        }

        /* ESTAD√çSTICAS Y PANEL DE ECONOM√çA 
        */
        .stats-panel {
            background: #ffffff;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }

        .money-label {
            font-size: 30px;
            font-weight: 900;
            color: #2ecc71;
            display: block;
            margin-bottom: 5px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }

        .price-label {
            font-size: 14px;
            color: #b2bec3;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* SELECTOR DE HUEVOS (EGG SELECTOR) 
        */
        .egg-type-bar {
            display: flex;
            background: #f1f2f6;
            border-radius: 15px;
            padding: 6px;
            gap: 6px;
            margin-bottom: 20px;
        }

        .egg-opt {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 12px;
            color: #7f8c8d;
            background: transparent;
            transition: 0.2s;
        }

        .egg-opt.active {
            background: white;
            color: #2d3436;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* BOTONES DE ACCI√ìN (COMPRAR / REBIRTH) 
        */
        .btn-action {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 900;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #buyBtn {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        #buyBtn:active {
            transform: scale(0.96);
        }

        #rebirthBtn {
            background: #0984e3;
            color: white;
            font-size: 14px;
            box-shadow: 0 6px 15px rgba(9, 132, 227, 0.3);
        }

        #rebirthBtn:disabled {
            background: #b2bec3;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }/* SISTEMA DE INVENTARIO Y SCROLL */
        #inventory {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
            padding-right: 8px;
            scrollbar-width: thin;
        }

        #inventory::-webkit-scrollbar { width: 6px; }
        #inventory::-webkit-scrollbar-thumb { background: #dfe6e9; border-radius: 10px; }

        /* CARTAS DE MASCOTAS (DISE√ëO PREMIUM) */
        .pet-card {
            background: #ffffff;
            border-radius: 18px;
            padding: 12px 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 6px solid #ccc;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideIn {
            from { transform: translateX(-30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* COLORES DE RAREZA ORIGINALES (EXTENDIDOS) */
        .rarity-common { border-color: #95a5a6; background: #f8f9fa; }
        .rarity-uncommon { border-color: #2ecc71; background: #f0fff4; }
        .rarity-rare { border-color: #3498db; background: #ebf8ff; }
        .rarity-god { border-color: #9b59b6; background: #faf5ff; }
        .rarity-secret { border-color: #f1c40f; background: #fffdf2; }
        .rarity-og { border-color: #e91e63; background: #fff5f7; }

        .sell-btn {
            background: #ff7675;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.2s;
        }

        .sell-btn:hover { background: #d63031; }

        /* OVERLAY DE APERTURA (HATCHING) */
        #hatch-screen {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.9);
            border-radius: 25px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: white;
        }

        .egg-sprite {
            width: 140px;
            height: 180px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #f1c40f);
            border-radius: 50% 50% 45% 45%;
            border: 6px solid #d4ac0d;
            box-shadow: 0 0 30px rgba(241, 196, 15, 0.4);
            margin-bottom: 25px;
        }

        .shake { animation: shake 0.12s infinite; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-1px, -2px) rotate(-1deg); }
            40% { transform: translate(-3px, 0px) rotate(1deg); }
            60% { transform: translate(3px, 2px) rotate(0deg); }
            80% { transform: translate(1px, -1px) rotate(1deg); }
            100% { transform: translate(-1px, 2px) rotate(-1deg); }
        }
    </style>
</head>
<body>

    <div id="hatch-screen">
        <div id="egg-visual" class="egg-sprite"></div>
        <div id="hatch-result" style="display:none; text-align:center;">
            <div id="res-icon" style="font-size: 90px; margin-bottom: 15px;"></div>
            <h2 id="res-name" style="font-size: 32px; text-transform: uppercase;"></h2>
            <p id="res-rarity" style="font-weight: 900; letter-spacing: 2px; margin-bottom: 25px;"></p>
            <button onclick="closeHatch()" class="btn-action" style="background:white; color:#333; width:220px;">CONFIRMAR</button>
        </div>
    </div>

    <div id="game-frame">
        <header>
            <h1>Pet Simulator</h1>
            <div class="tab-system">
                <button id="tabGame" class="tab-btn active" onclick="switchTab('game')">JUEGO</button>
                <button id="tabIndex" class="tab-btn" onclick="switchTab('index')">COLECCI√ìN</button>
            </div>
        </header>

        <div id="view-game">
            <div class="stats-panel">
                <span class="money-label">üí∞ $<span id="val-money">0</span></span>
                <span class="price-label">COSTO ACTUAL: $<span id="val-price">10</span></span>
            </div>

            <div class="egg-type-bar">
                <button id="egg-n" class="egg-opt active" onclick="setEgg('normal')">HUEVO B√ÅSICO</button>
                <button id="egg-s" class="egg-opt" onclick="setEgg('special')">HUEVO √âPICO</button>
            </div>

            <button id="buyBtn" class="btn-action" onclick="buyEgg()">ABRIR HUEVO</button>
            <button id="rebirthBtn" class="btn-action" onclick="doRebirth()" disabled>REALIZAR REBIRTH</button>

            <div id="inventory"></div>
        </div>

        <div id="view-index" style="display:none; flex:1; overflow-y:auto;">
            <div id="index-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:5px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDpmb0duQ3ZgjbipPWsMvpLx3d-vojQAxM",
            authDomain: "inici-de-sessio.firebaseapp.com",
            projectId: "inici-de-sessio",
            storageBucket: "inici-de-sessio.firebasestorage.app",
            messagingSenderId: "106046428749",
            appId: "1:106046428749:web:c555c61ff94f5f5691ee04",
            databaseURL: "https://inici-de-sessio-default-rtdb.europe-west1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const userRef = ref(db, 'users/save_slot_01');

        // CATALOGO EXTENDIDO DE MASCOTAS
        const POOL_NORMAL = [
            { id: 101, n: 'Rat√≥n', i: 'üê≠', r: 'common', e: 5 },
            { id: 102, n: 'Perro', i: 'üê∂', r: 'common', e: 8 },
            { id: 103, n: 'Gato', i: 'üê±', r: 'common', e: 12 },
            { id: 104, n: 'Conejo', i: 'üê∞', r: 'uncommon', e: 25 },
            { id: 105, n: 'Zorro', i: 'ü¶ä', r: 'uncommon', e: 40 },
            { id: 106, n: 'Ciervo', i: 'ü¶å', r: 'uncommon', e: 55 },
            { id: 107, n: 'Panda', i: 'üêº', r: 'rare', e: 120 },
            { id: 108, n: 'Le√≥n', i: 'ü¶Å', r: 'rare', e: 200 },
            { id: 109, n: 'Tibur√≥n', i: 'ü¶à', r: 'rare', e: 350 },
            { id: 110, n: 'Drag√≥n', i: 'üê≤', r: 'god', e: 800 },
            { id: 111, n: 'Unicornio', i: 'ü¶Ñ', r: 'secret', e: 2500 }
        ];

        const POOL_SPECIAL = [
            { id: 201, n: 'Rat√≥n Pro', i: 'üê≠', r: 'uncommon', e: 150 },
            { id: 202, n: 'Perro Robot', i: 'üê∂', r: 'rare', e: 400 },
            { id: 203, n: 'Lobo Alfa', i: 'üê∫', r: 'rare', e: 650 },
            { id: 204, n: 'Tigre Blanco', i: 'üêØ', r: 'rare', e: 900 },
            { id: 205, n: 'F√©nix', i: 'üî•', r: 'god', e: 2000 },
            { id: 206, n: 'Drag√≥n Negro', i: 'üêâ', r: 'god', e: 4500 },
            { id: 207, n: 'Kraken', i: 'üêô', r: 'secret', e: 12000 },
            { id: 208, n: 'Leviat√°n', i: 'üêã', r: 'secret', e: 18000 },
            { id: 209, n: 'T-Rex Antiguo', i: 'ü¶ñ', r: 'og', e: 50000 }
        ];// =====================================================================
        // ESTADO GLOBAL DEL JUEGO (GAME STATE)
        // =====================================================================
        let money = 0;
        let priceN = 10;
        let priceS = 1000;
        let rebirths = 0;
        let multiplier = 1;
        let currentEggType = 'normal';
        let inventory = [];
        let discoveredIds = [];

        // =====================================================================
        // N√öCLEO DE PERSISTENCIA (FIREBASE ENGINE)
        // =====================================================================
        async function saveData() {
            try {
                // Preparamos el objeto de guardado con timestamp de seguridad
                const payload = {
                    money: money,
                    priceN: priceN,
                    priceS: priceS,
                    rebirths: rebirths,
                    multiplier: multiplier,
                    inventory: inventory,
                    discoveredIds: discoveredIds,
                    lastSync: Date.now()
                };
                await set(userRef, payload);
                console.log(">> [Sync] Progreso guardado exitosamente.");
            } catch (error) {
                console.error(">> [Error] Fallo en la sincronizaci√≥n:", error);
            }
        }

        async function loadData() {
            console.log(">> [Auth] Iniciando carga de datos del jugador...");
            try {
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // Asignaci√≥n de variables con valores por defecto (Defaulting)
                    money = data.money ?? 10;
                    priceN = data.priceN || 10;
                    priceS = data.priceS || 1000;
                    rebirths = data.rebirths || 0;
                    multiplier = data.multiplier || 1;
                    inventory = data.inventory || [];
                    discoveredIds = data.discoveredIds || [];

                    // SISTEMA ANTI-BLOQUEO (M√≠nimo viable para jugar)
                    if (money < 10 && inventory.length === 0) {
                        money = 10;
                        console.log(">> [Security] Jugador sin recursos detectado. Balance ajustado.");
                    }
                    
                    renderUI();
                } else {
                    console.log(">> [Setup] No existe partida. Generando cuenta nueva...");
                    money = 10;
                    renderUI();
                    await saveData();
                }
            } catch (e) {
                console.error(">> [Critical] Error de conexi√≥n a la base de datos.");
                money = 10; // Fail-safe
                renderUI();
            }
        }

        // =====================================================================
        // MOTOR GR√ÅFICO (UI UPDATER)
        // =====================================================================
        window.renderUI = function() {
            // Actualizaci√≥n de etiquetas de texto
            document.getElementById('val-money').textContent = Math.floor(money).toLocaleString();
            document.getElementById('val-price').textContent = (currentEggType === 'normal' ? priceN : priceS).toLocaleString();
            
            const rbBtn = document.getElementById('rebirthBtn');
            const rbCost = (rebirths + 1) * 1000000;
            rbBtn.textContent = `‚ö° REBIRTH LVL ${rebirths} (Cost: ${rbCost.toLocaleString()})`;
            rbBtn.disabled = money < rbCost;

            // Renderizado del Inventario din√°mico
            const container = document.getElementById('inventory');
            container.innerHTML = '';

            inventory.forEach((pet, index) => {
                const card = document.createElement('div');
                card.className = `pet-card rarity-${pet.r}`;
                card.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:24px;">${pet.i}</span>
                        <div>
                            <div style="font-weight:900; font-size:14px;">${pet.n}</div>
                            <div style="font-size:10px; color:#666;">Ganancia: $${pet.e}/seg</div>
                        </div>
                    </div>
                    <button class="sell-btn" onclick="sellPet(${index})">VENDER</button>
                `;
                container.appendChild(card);
            });
        };

        // =====================================================================
        // CONTROLADORES DE EVENTOS (EVENT HANDLERS)
        // =====================================================================
        window.setEgg = function(type) {
            currentEggType = type;
            document.getElementById('egg-n').classList.toggle('active', type === 'normal');
            document.getElementById('egg-s').classList.toggle('active', type === 'special');
            renderUI();
        };

        window.buyEgg = function() {
            const cost = (currentEggType === 'normal' ? priceN : priceS);
            
            if (money < cost) {
                alert("¬°Faltan $" + (cost - money).toLocaleString() + " para comprar este huevo!");
                return;
            }

            // Deducci√≥n de dinero y escalado de precios
            money -= cost;
            if (currentEggType === 'normal') {
                priceN = Math.floor(priceN * 1.25);
            } else {
                priceS = Math.floor(priceS * 1.35);
            }

            executeHatchSequence();
        };

        function executeHatchSequence() {
            const overlay = document.getElementById('hatch-screen');
            const visual = document.getElementById('egg-visual');
            const result = document.getElementById('hatch-result');

            overlay.style.display = 'flex';
            visual.style.display = 'block';
            result.style.display = 'none';
            visual.classList.add('shake');

            // Simulaci√≥n de latencia de apertura
            setTimeout(() => {
                visual.classList.remove('shake');
                visual.style.display = 'none';
                
                const pool = (currentEggType === 'normal' ? POOL_NORMAL : POOL_SPECIAL);
                const roll = pool[Math.floor(Math.random() * pool.length)];
                
                // Registro de descubrimiento y guardado
                inventory.push(roll);
                if (!discoveredIds.includes(roll.id)) discoveredIds.push(roll.id);

                document.getElementById('res-icon').textContent = roll.i;
                document.getElementById('res-name').textContent = roll.n;
                document.getElementById('res-rarity').textContent = roll.r.toUpperCase();
                document.getElementById('res-rarity').style.color = getHex(roll.r);
                
                result.style.display = 'block';
                renderUI();
                saveData();
            }, 1500);
        }

        window.closeHatch = function() {
            document.getElementById('hatch-screen').style.display = 'none';
        };

        function getHex(rarity) {
            const colors = { common:'#7f8c8d', uncommon:'#2ecc71', rare:'#3498db', god:'#9b59b6', secret:'#f1c40f', og:'#e91e63' };
            return colors[rarity] || '#000000';
        }

        window.sellPet = function(idx) {
            const p = inventory[idx];
            // Valor de venta: 30 segundos de producci√≥n
            money += (p.e * 30);
            inventory.splice(idx, 1);
            renderUI();
            saveData();
        };

        window.doRebirth = function() {
            const cost = (rebirths + 1) * 1000000;
            if (money >= cost) {
                rebirths++;
                multiplier *= 2;
                money = 0;
                inventory = [];
                priceN = 10;
                priceS = 1000;
                renderUI();
                saveData();
                alert("¬°REBIRTH REALIZADO! Ahora ganas x" + multiplier + " veces m√°s.");
            }
        };

        window.switchTab = function(t) {
            document.getElementById('view-game').style.display = (t === 'game' ? 'block' : 'none');
            document.getElementById('view-index').style.display = (t === 'index' ? 'block' : 'none');
            document.getElementById('tabGame').classList.toggle('active', t === 'game');
            document.getElementById('tabIndex').classList.toggle('active', t === 'index');
            if (t === 'index') updateIndex();
        };

        function updateIndex() {
            const grid = document.getElementById('index-grid');
            grid.innerHTML = '';
            const allPets = [...POOL_NORMAL, ...POOL_SPECIAL];
            
            allPets.forEach(p => {
                const isFound = discoveredIds.includes(p.id);
                const item = document.createElement('div');
                item.style.cssText = `background:#eee; border-radius:15px; padding:15px; text-align:center; opacity:${isFound ? '1' : '0.4'}; filter:${isFound ? 'none' : 'grayscale(1)'};`;
                item.innerHTML = `
                    <div style="font-size:30px">${isFound ? p.i : '‚ùì'}</div>
                    <div style="font-size:12px; font-weight:bold; margin-top:5px">${isFound ? p.n : '???'}</div>
                `;
                grid.appendChild(item);
            });
        }

        // =====================================================================
        // SISTEMAS DE TIEMPO REAL (DAEMON LOOPS)
        // =====================================================================
        setInterval(() => {
            // C√°lculo masivo de ingresos pasivos
            let earningsPerSec = inventory.reduce((total, pet) => total + pet.e, 0);
            
            if (earningsPerSec > 0) {
                money += (earningsPerSec * multiplier);
                // Actualizaci√≥n optimizada del marcador de dinero
                document.getElementById('val-money').textContent = Math.floor(money).toLocaleString();
                
                // L√≥gica de validaci√≥n de bot√≥n de rebirth por segundo
                const rbCost = (rebirths + 1) * 1000000;
                if (money >= rbCost) {
                    document.getElementById('rebirthBtn').disabled = false;
                }
            }
        }, 1000);

        // Guardado autom√°tico por intervalos de seguridad (cada 25 segundos)
        setInterval(saveData, 25000);

        // INICIALIZACI√ìN DE LA INSTANCIA DE JUEGO
        loadData();

    </script>
</body>
</html>
