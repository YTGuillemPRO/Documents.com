<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ChatGPT Offline Avanzado</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
    #chat { flex: 1; padding: 10px; overflow-y: auto; background: #fff; }
    #chat div { margin-bottom: 10px; }
    #input-container { display: flex; padding: 10px; background: #ddd; }
    #input { flex: 1; padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; }
    #btn-send { padding: 10px 20px; margin-left: 10px; font-size: 16px; border: none; border-radius: 5px; background: #4caf50; color: white; cursor: pointer; }
  </style>
</head>
<body>

  <div id="chat"></div>

  <div id="input-container">
    <input type="text" id="input" placeholder="Escribe algo...">
    <button id="btn-send">Enviar</button>
  </div>

  <script>
    /* ================= MEMORIA ================= */
    let memoria = JSON.parse(localStorage.getItem("memoriaIA")) || {
      nombre: "IA",
      conocimientos: {}
    };

    function guardar() {
      localStorage.setItem("memoriaIA", JSON.stringify(memoria));
    }

    /* ================= CHAT ================= */
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");

    function add(q, t) {
      chat.innerHTML += `<div><b>${q}:</b> ${t}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    /* ================= FUNCIONES MATEM√ÅTICAS ================= */
    function factorial(n) {
      if(n < 0) return NaN;
      let f = 1;
      for(let i=2;i<=n;i++) f*=i;
      return f;
    }

    function combinatoria(n,k){
      return factorial(n)/(factorial(k)*factorial(n-k));
    }

    function raiz(n, r=2){
      return Math.pow(n, 1/r);
    }

    function parseOperacion(texto){
      // Convertir palabras a n√∫meros
      const numeros = {"cero":0,"uno":1,"una":1,"dos":2,"tres":3,"cuatro":4,"cinco":5,
                       "seis":6,"siete":7,"ocho":8,"nueve":9,"diez":10};
      for(let n in numeros){
        texto = texto.replaceAll(n, numeros[n]);
      }

      texto = texto.toLowerCase()
        .replace(/cuanto es|cu√°nto es|calcula|resultado de/g,"")
        .replace(/\bpor\b/g,"*")
        .replace(/\bentre\b|\bdividido\b/g,"/")
        .replace(/m√°s/g,"+")
        .replace(/menos/g,"-")
        .replace(/x/g,"*") // ‚úÖ Multiplicaci√≥n con "x"
        .replace(/elevado a/g,"**")
        .replace(/factorial de (\d+)/g,"factorial($1)")
        .replace(/ra√≠z de (\d+)/g,"raiz($1)")
        .replace(/ra√≠z (\d+) de (\d+)/g,"raiz($2,$1)")
        .replace(/combinatoria (\d+) entre (\d+)/g,"combinatoria($1,$2)");

      return texto.replace(/[^0-9+\-*/().**factorialcombinatoriaraiz ]/g,"");
    }

    function resolver(texto){
      try {
        const expr = parseOperacion(texto);
        if(!expr) return null;
        const r = eval(expr);
        if(!isNaN(r)) return "El resultado es " + r;
      } catch(e) { return null; }
      return null;
    }

    /* ================= INTELIGENCIA ================= */
    function pensar(texto) {
      texto = texto.toLowerCase();

      // Cambiar nombre
      if (texto.startsWith("llamate ")) {
        const nuevoNombre = texto.replace("llamate ", "").trim();
        if (nuevoNombre) {
          memoria.nombre = nuevoNombre;
          guardar();
          return `He cambiado mi nombre a ${memoria.nombre} ‚úÖ`;
        } else return "No entend√≠ el nombre üòÖ";
      }

      // Aprender cosas nuevas
      if (texto.startsWith("aprende que")) {
        const p = texto.replace("aprende que","").split(" es ");
        if(p.length===2){
          memoria.conocimientos[p[0].trim()] = p[1].trim();
          guardar();
          return "He aprendido eso üß†";
        }
      }

      // Matem√°ticas complejas
      const r = resolver(texto);
      if(r) return r;

      // Conocimientos previos
      for(let k in memoria.conocimientos){
        if(texto.includes(k)) return memoria.conocimientos[k];
      }

      // Saludos b√°sicos
      if(texto.includes("hola")) return `Hola üëã, soy ${memoria.nombre}`;
      if(texto.includes("quien eres")) return `Soy ${memoria.nombre}, tu asistente offline ü§ñ`;

      return "No lo s√© a√∫n, pero puedo calcular y aprender üß†";
    }

    /* ================= ENVIAR ================= */
    function enviar() {
      if(!input.value) return;
      add("T√∫", input.value);
      const r = pensar(input.value);
      add(memoria.nombre, r);
      input.value = "";
    }

    document.getElementById("btn-send").onclick = enviar;
    input.addEventListener("keydown", function(e){
      if(e.key==="Enter") enviar();
    });

    // Mensaje de bienvenida
    add(memoria.nombre, `Hola, soy tu asistente offline. Puedes cambiar mi nombre escribiendo 'llamate <nombre>' o ense√±arme cosas con 'aprende que ... es ...'. Puedo resolver operaciones complejas como factoriales, ra√≠ces, combinatorias, potencias y par√©ntesis anidados. Tambi√©n puedes escribir multiplicaciones con "x", por ejemplo: 80x33.`);
  </script>

</body>
</html>
