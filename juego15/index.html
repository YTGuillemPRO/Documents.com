<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FPS 3D Realista FIXED</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;background:#000;font-family:monospace}
#hud{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none}
#crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#0f0;font-size:28px}
.panel{position:absolute;background:rgba(0,0,0,.7);padding:10px 15px;border:2px solid}
#ammo{bottom:20px;right:20px;color:#0f0;border-color:#0f0}
#health{bottom:20px;left:20px;color:#f00;border-color:#f00}
#kills{top:20px;left:20px;color:#ff0;border-color:#ff0}
#menu,#gameover{
position:fixed;top:0;left:0;width:100%;height:100%;
display:flex;align-items:center;justify-content:center;
flex-direction:column;background:#000;z-index:10;color:white
}
button{padding:15px 40px;font-size:20px;font-weight:bold;cursor:pointer}
</style>
</head>

<body>

<div id="menu">
<h1>FPS 3D</h1>
<button onclick="startGame()">INICIAR</button>
<p>WASD mover | Ratón mirar | Click disparar</p>
</div>

<div id="gameover" style="display:none">
<h1>K.I.A.</h1>
<p id="final"></p>
<button onclick="location.reload()">REINTENTAR</button>
</div>

<div id="hud">
<div id="crosshair">+</div>
<div id="ammo" class="panel">AMMO: <span id="ammoVal">30</span></div>
<div id="health" class="panel">SALUD: <span id="healthVal">100</span></div>
<div id="kills" class="panel">BAJAS: <span id="killVal">0</span></div>
</div>

<canvas id="c"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
let scene,camera,renderer
let yaw=new THREE.Object3D()
let pitch=new THREE.Object3D()
let raycaster=new THREE.Raycaster()

let player={health:100,ammo:30,maxAmmo:30,kills:0}
let enemies=[]
let keys={}
let mouse={x:0,y:0}
let playing=false
let weapon

function init(){
scene=new THREE.Scene()
scene.background=new THREE.Color(0x6b7a86)
scene.fog=new THREE.Fog(0x6b7a86,5,60)

camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,200)

yaw.position.y=1.7
yaw.add(pitch)
pitch.add(camera)
scene.add(yaw)

renderer=new THREE.WebGLRenderer({canvas:c,antialias:true})
renderer.setSize(innerWidth,innerHeight)
renderer.shadowMap.enabled=true

scene.add(new THREE.HemisphereLight(0xffffff,0x444444,0.6))

let sun=new THREE.DirectionalLight(0xffffff,0.9)
sun.position.set(10,20,5)
sun.castShadow=true
scene.add(sun)

createGround()
createBuildings()
createWeapon()

addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true)
addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false)
addEventListener('mousemove',e=>{
if(!playing)return
mouse.x=e.movementX
mouse.y=e.movementY
})
addEventListener('click',shoot)
addEventListener('resize',resize)

animate()
}

function createGround(){
let g=new THREE.PlaneGeometry(200,200)
let m=new THREE.MeshStandardMaterial({color:0x2f2f2f})
let ground=new THREE.Mesh(g,m)
ground.rotation.x=-Math.PI/2
ground.receiveShadow=true
scene.add(ground)
}

function createBuildings(){
for(let i=0;i<40;i++){
let h=5+Math.random()*15
let b=new THREE.Mesh(
new THREE.BoxGeometry(4,h,4),
new THREE.MeshStandardMaterial({color:0x777777})
)
b.position.set((Math.random()-0.5)*80,h/2,(Math.random()-0.5)*80)
b.castShadow=b.receiveShadow=true
scene.add(b)
}
}

function createWeapon(){
weapon=new THREE.Group()

// cuerpo con "arrugas"
let bodyGeo=new THREE.BoxGeometry(0.15,0.12,1,8,4,20)
let pos=bodyGeo.attributes.position
for(let i=0;i<pos.count;i++){
pos.setY(i,pos.getY(i)+(Math.random()-0.5)*0.002)
}
pos.needsUpdate=true

let body=new THREE.Mesh(
bodyGeo,
new THREE.MeshStandardMaterial({color:0x222,roughness:0.6,metalness:0.4})
)
body.position.set(0.35,-0.3,-0.8)
weapon.add(body)

// cañón
let barrel=new THREE.Mesh(
new THREE.CylinderGeometry(0.02,0.025,0.8,16),
new THREE.MeshStandardMaterial({color:0x111,metalness:0.8})
)
barrel.rotation.x=Math.PI/2
barrel.position.set(0.35,-0.28,-1.3)
weapon.add(barrel)

// cargador
let mag=new THREE.Mesh(
new THREE.BoxGeometry(0.08,0.2,0.15),
new THREE.MeshStandardMaterial({color:0x333})
)
mag.position.set(0.35,-0.45,-0.6)
weapon.add(mag)

pitch.add(weapon)
}

function spawnEnemies(){
for(let i=0;i<6;i++){
let e=new THREE.Mesh(
new THREE.CapsuleGeometry(0.35,1.2),
new THREE.MeshStandardMaterial({color:0xaa0000})
)
e.position.set(
(Math.random()-0.5)*20,
1,
-10-Math.random()*10
)
e.castShadow=true
scene.add(e)
enemies.push({mesh:e,health:100})
}
}

function shoot(){
if(!playing||player.ammo<=0)return
player.ammo--
updateHUD()

weapon.position.z+=0.08
setTimeout(()=>weapon.position.z-=0.08,60)

raycaster.setFromCamera(new THREE.Vector2(0,0),camera)
let hits=raycaster.intersectObjects(enemies.map(e=>e.mesh))
if(hits.length){
let enemy=enemies.find(e=>e.mesh===hits[0].object)
enemy.health-=50
if(enemy.health<=0){
scene.remove(enemy.mesh)
enemies.splice(enemies.indexOf(enemy),1)
player.kills++
updateHUD()
}
}
}

function updatePlayer(){
let speed=0.15
let forward=new THREE.Vector3(
Math.sin(yaw.rotation.y),
0,
Math.cos(yaw.rotation.y)*-1
)
let right=new THREE.Vector3(forward.z,0,-forward.x)

if(keys.w) yaw.position.add(forward.clone().multiplyScalar(speed))
if(keys.s) yaw.position.add(forward.clone().multiplyScalar(-speed))
if(keys.a) yaw.position.add(right.clone().multiplyScalar(-speed))
if(keys.d) yaw.position.add(right.clone().multiplyScalar(speed))

yaw.rotation.y-=mouse.x*0.002
pitch.rotation.x-=mouse.y*0.002
pitch.rotation.x=Math.max(-1.4,Math.min(1.4,pitch.rotation.x))
mouse.x=mouse.y=0
}

function updateEnemies(){
for(let e of enemies){
let dir=yaw.position.clone().sub(e.mesh.position)
let dist=dir.length()
dir.normalize()
if(dist>2)e.mesh.position.add(dir.multiplyScalar(0.04))
else{
player.health-=0.3
updateHUD()
if(player.health<=0)gameOver()
}
}
}

function updateHUD(){
ammoVal.textContent=player.ammo
healthVal.textContent=Math.max(0,player.health|0)
killVal.textContent=player.kills
}

function animate(){
requestAnimationFrame(animate)
if(playing){
updatePlayer()
updateEnemies()
}
renderer.render(scene,camera)
}

function startGame(){
menu.style.display='none'
playing=true
spawnEnemies()
document.body.requestPointerLock()
}

function gameOver(){
playing=false
final.textContent='BAJAS: '+player.kills
gameover.style.display='flex'
document.exitPointerLock()
}

function resize(){
camera.aspect=innerWidth/innerHeight
camera.updateProjectionMatrix()
renderer.setSize(innerWidth,innerHeight)
}

window.onload=init
</script>
</body>
</html>
