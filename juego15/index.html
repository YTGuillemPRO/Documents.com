<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FPS 3D CONTROLES FIX</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;background:#000;font-family:monospace}
canvas{display:block}

#hud{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none}
#crosshair{
position:absolute;top:50%;left:50%;
transform:translate(-50%,-50%);
color:#0f0;font-size:28px
}
.panel{
position:absolute;background:rgba(0,0,0,.7);
padding:10px 15px;border:2px solid
}
#ammo{bottom:20px;right:20px;color:#0f0;border-color:#0f0}
#health{bottom:20px;left:20px;color:#f00;border-color:#f00}
#kills{top:20px;left:20px;color:#ff0;border-color:#ff0}

#menu,#gameover{
position:fixed;top:0;left:0;width:100%;height:100%;
display:flex;align-items:center;justify-content:center;
flex-direction:column;background:#000;color:#fff;z-index:10
}
button{padding:15px 40px;font-size:20px;font-weight:bold;cursor:pointer}
</style>
</head>

<body>

<div id="menu">
<h1>FPS 3D</h1>
<button onclick="startGame()">INICIAR</button>
<p>WASD mover | Rat√≥n mirar | Espacio saltar | Shift sprint | Ctrl crouch/slide</p>
</div>

<div id="gameover" style="display:none">
<h1>K.I.A.</h1>
<p id="final"></p>
<button onclick="location.reload()">REINTENTAR</button>
</div>

<div id="hud">
<div id="crosshair">+</div>
<div id="ammo" class="panel">AMMO: <span id="ammoVal">30</span></div>
<div id="health" class="panel">SALUD: <span id="healthVal">100</span></div>
<div id="kills" class="panel">BAJAS: <span id="killVal">0</span></div>
</div>

<canvas id="c"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
let scene,camera,renderer
let yaw=new THREE.Object3D()
let pitch=new THREE.Object3D()
let raycaster=new THREE.Raycaster()

let player={
health:100,ammo:30,kills:0,
velocityY:0,
onGround:true,
height:1.7,
speed:0.12
}

let enemies=[]
let keys={}
let mouse={x:0,y:0}
let playing=false
let weapon
const GRAVITY=0.008

function init(){
scene=new THREE.Scene()
scene.background=new THREE.Color(0x6a7a86)
scene.fog=new THREE.Fog(0x6a7a86,5,50)

camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,200)

yaw.position.y=player.height
yaw.add(pitch)
pitch.add(camera)
scene.add(yaw)

renderer=new THREE.WebGLRenderer({canvas:c,antialias:true})
renderer.setSize(innerWidth,innerHeight)
renderer.shadowMap.enabled=true

scene.add(new THREE.HemisphereLight(0xffffff,0x444444,0.6))
let sun=new THREE.DirectionalLight(0xffffff,0.8)
sun.position.set(10,20,10)
scene.add(sun)

createGround()
createWeapon()

addEventListener('keydown',e=>keys[e.code]=true)
addEventListener('keyup',e=>keys[e.code]=false)

addEventListener('mousemove',e=>{
if(!playing)return
mouse.x=e.movementX
mouse.y=e.movementY
})

addEventListener('click',shoot)
addEventListener('resize',resize)

animate()
}

function createGround(){
let g=new THREE.PlaneGeometry(200,200)
let m=new THREE.MeshStandardMaterial({color:0x333})
let ground=new THREE.Mesh(g,m)
ground.rotation.x=-Math.PI/2
scene.add(ground)
}

function createWeapon(){
weapon=new THREE.Group()

let bodyGeo=new THREE.BoxGeometry(0.15,0.12,1,10,4,20)
let pos=bodyGeo.attributes.position
for(let i=0;i<pos.count;i++){
pos.setY(i,pos.getY(i)+(Math.random()-0.5)*0.002)
}
pos.needsUpdate=true

let body=new THREE.Mesh(
bodyGeo,
new THREE.MeshStandardMaterial({color:0x222,roughness:.6,metalness:.4})
)
body.position.set(0.35,-0.3,-0.8)
weapon.add(body)

let barrel=new THREE.Mesh(
new THREE.CylinderGeometry(0.02,0.025,0.8,16),
new THREE.MeshStandardMaterial({color:0x111,metalness:.8})
)
barrel.rotation.x=Math.PI/2
barrel.position.set(0.35,-0.28,-1.3)
weapon.add(barrel)

pitch.add(weapon)
}

function spawnEnemies(){
for(let i=0;i<6;i++){
let e=new THREE.Mesh(
new THREE.CapsuleGeometry(0.35,1.2),
new THREE.MeshStandardMaterial({color:0xaa0000})
)
e.position.set((Math.random()-0.5)*10,1,-10-Math.random()*10)
scene.add(e)
enemies.push({mesh:e,health:100})
}
}

function shoot(){
if(!playing||player.ammo<=0)return
player.ammo--
updateHUD()

weapon.position.z+=0.08
setTimeout(()=>weapon.position.z-=0.08,50)

raycaster.setFromCamera(new THREE.Vector2(0,0),camera)
let hits=raycaster.intersectObjects(enemies.map(e=>e.mesh))
if(hits.length){
let enemy=enemies.find(e=>e.mesh===hits[0].object)
enemy.health-=50
if(enemy.health<=0){
scene.remove(enemy.mesh)
enemies.splice(enemies.indexOf(enemy),1)
player.kills++
updateHUD()
}
}
}

function updatePlayer(){
let speed=player.speed
let sprint=keys.ShiftLeft
let crouch=keys.ControlLeft

camera.fov=sprint?80:75
camera.updateProjectionMatrix()

let forward=new THREE.Vector3(
Math.sin(yaw.rotation.y),
0,
-Math.cos(yaw.rotation.y)
)
let right=new THREE.Vector3(forward.z,0,-forward.x)

if(sprint) speed*=1.8
if(crouch){
speed*=0.5
yaw.position.y=1.1
}else{
yaw.position.y=player.height
}

if(keys.KeyW) yaw.position.add(forward.clone().multiplyScalar(speed))
if(keys.KeyS) yaw.position.add(forward.clone().multiplyScalar(-speed))
if(keys.KeyA) yaw.position.add(right.clone().multiplyScalar(-speed))
if(keys.KeyD) yaw.position.add(right.clone().multiplyScalar(speed))

// salto
if(keys.Space && player.onGround){
player.velocityY=0.18
player.onGround=false
}

player.velocityY-=GRAVITY
yaw.position.y+=player.velocityY
if(yaw.position.y<=player.height){
yaw.position.y=player.height
player.velocityY=0
player.onGround=true
}

yaw.rotation.y-=mouse.x*0.002
pitch.rotation.x-=mouse.y*0.002
pitch.rotation.x=Math.max(-1.4,Math.min(1.4,pitch.rotation.x))
mouse.x=mouse.y=0
}

function updateEnemies(){
for(let e of enemies){
let dir=yaw.position.clone().sub(e.mesh.position)
let dist=dir.length()
dir.normalize()
if(dist>2)e.mesh.position.add(dir.multiplyScalar(0.035))
else{
player.health-=0.3
updateHUD()
if(player.health<=0)gameOver()
}
}
}

function updateHUD(){
ammoVal.textContent=player.ammo
healthVal.textContent=Math.max(0,player.health|0)
killVal.textContent=player.kills
}

function animate(){
requestAnimationFrame(animate)
if(playing){
updatePlayer()
updateEnemies()
}
renderer.render(scene,camera)
}

function startGame(){
menu.style.display='none'
playing=true
spawnEnemies()
document.body.requestPointerLock()
document.body.style.cursor='none'
}

function gameOver(){
playing=false
final.textContent='BAJAS: '+player.kills
gameover.style.display='flex'
document.exitPointerLock()
document.body.style.cursor='default'
}

function resize(){
camera.aspect=innerWidth/innerHeight
camera.updateProjectionMatrix()
renderer.setSize(innerWidth,innerHeight)
}

window.onload=init
</script>
</body>
</html>
