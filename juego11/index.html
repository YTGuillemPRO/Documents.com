import React, { useState, useEffect, useRef } from 'react';
import { Trophy, Zap, Star, ShoppingBag, Home, Play, Crown, Rabbit, Cat, Dog, Bird } from 'lucide-react';

const RobloxObbyGame = () => {
  const [screen, setScreen] = useState('menu');
  const [coins, setCoins] = useState(0);
  const [wins, setWins] = useState(0);
  const [speed, setSpeed] = useState(1);
  const [selectedObby, setSelectedObby] = useState(null);
  const [pets, setPets] = useState([]);
  const [equippedPet, setEquippedPet] = useState(null);
  const [playerPos, setPlayerPos] = useState({ x: 0, y: 2, z: 0 });
  const [playerVel, setPlayerVel] = useState({ x: 0, y: 0, z: 0 });
  const [isJumping, setIsJumping] = useState(false);
  const [currentStage, setCurrentStage] = useState(0);
  const [gameActive, setGameActive] = useState(false);
  const [gameTime, setGameTime] = useState(0);
  
  const canvasRef = useRef(null);
  const keysPressed = useRef({});
  const animFrame = useRef(null);

  const OBBYS = [
    {
      id: 1,
      name: "Obby Clásico",
      difficulty: "Fácil",
      reward: 50,
      color: '#4CAF50',
      stages: [
        { x: 0, y: 0, z: 0, w: 4, d: 4, c: '#8BC34A' },
        { x: 6, y: 0, z: 0, w: 4, d: 4, c: '#8BC34A' },
        { x: 12, y: 1, z: 0, w: 4, d: 4, c: '#8BC34A' },
        { x: 18, y: 2, z: 0, w: 4, d: 4, c: '#8BC34A' },
        { x: 24, y: 3, z: 0, w: 4, d: 4, c: '#FFD700' }
      ]
    },
    {
      id: 2,
      name: "Obby de Lava",
      difficulty: "Medio",
      reward: 100,
      color: '#FF5722',
      stages: [
        { x: 0, y: 0, z: 0, w: 3, d: 3, c: '#FF7043' },
        { x: 5, y: 0, z: 0, w: 3, d: 3, c: '#FF7043' },
        { x: 10, y: 1, z: 0, w: 3, d: 3, c: '#FF7043' },
        { x: 15, y: 2, z: 0, w: 3, d: 3, c: '#FF7043' },
        { x: 20, y: 3, z: 2, w: 3, d: 3, c: '#FF7043' },
        { x: 25, y: 4, z: 0, w: 3, d: 3, c: '#FFD700' }
      ]
    },
    {
      id: 3,
      name: "Obby Espacial",
      difficulty: "Difícil",
      reward: 200,
      color: '#9C27B0',
      stages: [
        { x: 0, y: 0, z: 0, w: 2.5, d: 2.5, c: '#BA68C8' },
        { x: 4, y: 0.5, z: 0, w: 2.5, d: 2.5, c: '#BA68C8' },
        { x: 8, y: 1, z: 2, w: 2.5, d: 2.5, c: '#BA68C8' },
        { x: 12, y: 2, z: 0, w: 2.5, d: 2.5, c: '#BA68C8' },
        { x: 16, y: 3, z: -2, w: 2.5, d: 2.5, c: '#BA68C8' },
        { x: 20, y: 4, z: 0, w: 2.5, d: 2.5, c: '#BA68C8' },
        { x: 24, y: 5, z: 0, w: 2.5, d: 2.5, c: '#FFD700' }
      ]
    },
    {
      id: 4,
      name: "Obby Extremo",
      difficulty: "Experto",
      reward: 500,
      color: '#F44336',
      stages: [
        { x: 0, y: 0, z: 0, w: 2, d: 2, c: '#EF5350' },
        { x: 3, y: 0.5, z: 1, w: 2, d: 2, c: '#EF5350' },
        { x: 6, y: 1, z: -1, w: 2, d: 2, c: '#EF5350' },
        { x: 9, y: 2, z: 0, w: 2, d: 2, c: '#EF5350' },
        { x: 12, y: 3, z: 2, w: 2, d: 2, c: '#EF5350' },
        { x: 15, y: 4, z: -2, w: 2, d: 2, c: '#EF5350' },
        { x: 18, y: 5, z: 0, w: 2, d: 2, c: '#EF5350' },
        { x: 21, y: 6, z: 0, w: 2, d: 2, c: '#FFD700' }
      ]
    }
  ];

  const PETS = [
    { id: 1, name: "Conejo", icon: Rabbit, cost: 100, speedBoost: 0.2, color: '#FFB6C1' },
    { id: 2, name: "Gato", icon: Cat, cost: 250, speedBoost: 0.5, color: '#FFA500' },
    { id: 3, name: "Perro", icon: Dog, cost: 500, speedBoost: 0.8, color: '#8B4513' },
    { id: 4, name: "Pájaro", icon: Bird, cost: 1000, speedBoost: 1.2, color: '#00CED1' }
  ];

  const SPEED_UPGRADES = [
    { level: 1, cost: 0, speed: 1 },
    { level: 2, cost: 100, speed: 1.2 },
    { level: 3, cost: 300, speed: 1.5 },
    { level: 4, cost: 600, speed: 1.8 },
    { level: 5, cost: 1000, speed: 2.2 }
  ];

  const toIso = (x, y, z) => {
    const scale = 20;
    return {
      x: (x - z) * scale + 400,
      y: (x + z) * scale * 0.5 - y * scale + 300
    };
  };

  const drawBox = (ctx, x, y, z, w, h, d, color) => {
    const top1 = toIso(x - w/2, y + h, z - d/2);
    const top2 = toIso(x + w/2, y + h, z - d/2);
    const top3 = toIso(x + w/2, y + h, z + d/2);
    const top4 = toIso(x - w/2, y + h, z + d/2);
    
    const bot1 = toIso(x - w/2, y, z - d/2);
    const bot2 = toIso(x + w/2, y, z - d/2);
    const bot3 = toIso(x + w/2, y, z + d/2);
    const bot4 = toIso(x - w/2, y, z + d/2);

    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(top1.x, top1.y);
    ctx.lineTo(top2.x, top2.y);
    ctx.lineTo(top3.x, top3.y);
    ctx.lineTo(top4.x, top4.y);
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.stroke();

    const darkerColor = color.replace(/[0-9A-F]{2}$/, m => Math.max(0, parseInt(m, 16) - 40).toString(16).padStart(2, '0'));
    
    ctx.fillStyle = darkerColor;
    ctx.beginPath();
    ctx.moveTo(top2.x, top2.y);
    ctx.lineTo(bot2.x, bot2.y);
    ctx.lineTo(bot3.x, bot3.y);
    ctx.lineTo(top3.x, top3.y);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = darkerColor;
    ctx.beginPath();
    ctx.moveTo(top3.x, top3.y);
    ctx.lineTo(bot3.x, bot3.y);
    ctx.lineTo(bot4.x, bot4.y);
    ctx.lineTo(top4.x, top4.y);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
  };

  useEffect(() => {
    if (!gameActive) return;
    const timer = setInterval(() => setGameTime(t => t + 0.016), 16);
    return () => clearInterval(timer);
  }, [gameActive]);

  useEffect(() => {
    if (!gameActive || !selectedObby) return;
    const down = (e) => {
      e.preventDefault();
      keysPressed.current[e.key.toLowerCase()] = true;
    };
    const up = (e) => {
      e.preventDefault();
      keysPressed.current[e.key.toLowerCase()] = false;
    };
    window.addEventListener('keydown', down);
    window.addEventListener('keyup', up);
    return () => {
      window.removeEventListener('keydown', down);
      window.removeEventListener('keyup', up);
    };
  }, [gameActive, selectedObby]);

  useEffect(() => {
    if (!gameActive || !selectedObby) return;

    const gameLoop = setInterval(() => {
      const totalSpeed = speed * (equippedPet ? 1 + PETS.find(p => p.id === equippedPet)?.speedBoost : 1);
      const moveSpeed = 0.15 * totalSpeed;
      let newVel = { ...playerVel };
      let newPos = { ...playerPos };

      if (keysPressed.current['arrowleft'] || keysPressed.current['a']) newPos.x -= moveSpeed;
      if (keysPressed.current['arrowright'] || keysPressed.current['d']) newPos.x += moveSpeed;
      if (keysPressed.current['arrowup'] || keysPressed.current['w']) newPos.z -= moveSpeed;
      if (keysPressed.current['arrowdown'] || keysPressed.current['s']) newPos.z += moveSpeed;
      if (keysPressed.current[' '] && !isJumping) {
        newVel.y = 0.25;
        setIsJumping(true);
      }

      newVel.y -= 0.015;
      newPos.y += newVel.y;

      const obby = OBBYS.find(o => o.id === selectedObby);
      obby.stages.forEach((s, idx) => {
        if (Math.abs(newPos.x - s.x) < s.w / 2 && Math.abs(newPos.z - s.z) < s.d / 2 &&
            newPos.y <= s.y + 0.75 && newPos.y >= s.y - 0.5 && newVel.y <= 0) {
          newPos.y = s.y + 0.75;
          newVel.y = 0;
          setIsJumping(false);
          if (idx > currentStage) setCurrentStage(idx);
          if (idx === obby.stages.length - 1) setTimeout(() => completeObby(), 100);
        }
      });

      if (newPos.y < -5) {
        newPos = { x: 0, y: 2, z: 0 };
        newVel = { x: 0, y: 0, z: 0 };
        setCurrentStage(0);
      }

      setPlayerPos(newPos);
      setPlayerVel(newVel);
    }, 16);

    return () => clearInterval(gameLoop);
  }, [gameActive, selectedObby, playerPos, playerVel, isJumping, currentStage, speed, equippedPet]);

  useEffect(() => {
    if (screen !== 'game' || !selectedObby || !canvasRef.current) return;

    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');

    const render = () => {
      ctx.fillStyle = '#87CEEB';
      ctx.fillRect(0, 0, 800, 600);

      const obby = OBBYS.find(o => o.id === selectedObby);
      
      obby.stages.forEach((s, idx) => {
        drawBox(ctx, s.x, s.y, s.z, s.w, 0.5, s.d, s.c);
        const iso = toIso(s.x, s.y + 1, s.z);
        ctx.fillStyle = '#000';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(idx + 1, iso.x, iso.y);
      });

      drawBox(ctx, playerPos.x, playerPos.y, playerPos.z, 1, 1, 1, '#2196F3');

      if (equippedPet) {
        const t = Date.now() * 0.001;
        const petData = PETS.find(p => p.id === equippedPet);
        const px = playerPos.x + Math.sin(t * 3) * 1.5;
        const py = playerPos.y + Math.sin(t * 5) * 0.3 + 0.5;
        const pz = playerPos.z + Math.cos(t * 3) * 1.5;
        
        const iso = toIso(px, py, pz);
        ctx.fillStyle = petData.color;
        ctx.beginPath();
        ctx.arc(iso.x, iso.y, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      animFrame.current = requestAnimationFrame(render);
    };

    render();

    return () => {
      if (animFrame.current) cancelAnimationFrame(animFrame.current);
    };
  }, [screen, selectedObby, playerPos, equippedPet]);

  const startObby = (id) => {
    setSelectedObby(id);
    setPlayerPos({ x: 0, y: 2, z: 0 });
    setPlayerVel({ x: 0, y: 0, z: 0 });
    setCurrentStage(0);
    setGameActive(true);
    setGameTime(0);
    setScreen('game');
  };

  const completeObby = () => {
    const obby = OBBYS.find(o => o.id === selectedObby);
    const reward = Math.floor(obby.reward * (1 + (equippedPet ? PETS.find(p => p.id === equippedPet)?.speedBoost * 0.5 : 0)));
    setCoins(c => c + reward);
    setWins(w => w + 1);
    setGameActive(false);
    setTimeout(() => {
      alert(`¡Obby completado! +${reward} monedas`);
      setScreen('menu');
    }, 100);
  };

  const buySpeed = () => {
    const upgrade = SPEED_UPGRADES.find(u => u.level === speed + 1);
    if (upgrade && coins >= upgrade.cost) {
      setCoins(c => c - upgrade.cost);
      setSpeed(upgrade.level);
    }
  };

  const buyPet = (id) => {
    const pet = PETS.find(p => p.id === id);
    if (coins >= pet.cost && !pets.includes(id)) {
      setCoins(c => c - pet.cost);
      setPets(p => [...p, id]);
    }
  };

  if (screen === 'menu') return (
    <div className="min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="text-center mb-8">
          <h1 className="text-6xl font-bold text-white mb-4 drop-shadow-lg">OBBY GAME 3D</h1>
          <div className="flex justify-center gap-8 text-white text-xl">
            <div className="flex items-center gap-2 bg-black/30 px-4 py-2 rounded-full">
              <Star className="text-yellow-300" />
              <span>{coins} Monedas</span>
            </div>
            <div className="flex items-center gap-2 bg-black/30 px-4 py-2 rounded-full">
              <Trophy className="text-yellow-300" />
              <span>{wins} Victorias</span>
            </div>
            <div className="flex items-center gap-2 bg-black/30 px-4 py-2 rounded-full">
              <Zap className="text-yellow-300" />
              <span>Velocidad: {speed}x</span>
            </div>
          </div>
        </div>
        <div className="grid grid-cols-2 gap-4 mb-6">
          {OBBYS.map(o => (
            <div key={o.id} className="bg-white/90 rounded-xl p-6 shadow-xl">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-2xl font-bold" style={{color:o.color}}>{o.name}</h3>
                <span className="px-3 py-1 bg-gray-200 rounded-full text-sm">{o.difficulty}</span>
              </div>
              <p className="text-gray-700 mb-4">Recompensa: {o.reward} monedas</p>
              <button onClick={() => startObby(o.id)} className="w-full py-3 rounded-lg font-bold text-white hover:scale-105 transition" style={{backgroundColor:o.color}}>
                <Play className="inline mr-2" size={20} />Jugar
              </button>
            </div>
          ))}
        </div>
        <div className="flex gap-4">
          <button onClick={() => setScreen('shop')} className="flex-1 bg-white/90 rounded-xl p-6 shadow-xl hover:scale-105 transition">
            <ShoppingBag className="mx-auto mb-2 text-green-500" size={40} />
            <h3 className="text-xl font-bold text-center">Tienda</h3>
          </button>
          <button onClick={() => setScreen('pets')} className="flex-1 bg-white/90 rounded-xl p-6 shadow-xl hover:scale-105 transition">
            <Crown className="mx-auto mb-2 text-purple-500" size={40} />
            <h3 className="text-xl font-bold text-center">Mascotas</h3>
          </button>
        </div>
      </div>
    </div>
  );

  if (screen === 'game') return (
    <div className="min-h-screen bg-gradient-to-br from-gray-800 to-gray-900 p-8">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white/90 rounded-xl p-4 mb-4">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold">{OBBYS.find(o => o.id === selectedObby)?.name}</h2>
            <div className="flex gap-4">
              <span>Etapa: {currentStage + 1}/{OBBYS.find(o => o.id === selectedObby)?.stages.length}</span>
              <span>Tiempo: {gameTime.toFixed(1)}s</span>
            </div>
            <button onClick={() => { setGameActive(false); setScreen('menu'); }} className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Salir</button>
          </div>
        </div>
        <div className="bg-white rounded-xl p-4 shadow-xl">
          <canvas ref={canvasRef} width={800} height={600} className="w-full border-4 border-gray-300 rounded-lg" />
          <div className="mt-4 text-center text-gray-700">
            <p className="font-bold">Controles: W A S D o Flechas | ESPACIO para saltar</p>
          </div>
        </div>
      </div>
    </div>
  );

  if (screen === 'shop') return (
    <div className="min-h-screen bg-gradient-to-br from-green-400 to-blue-500 p-8">
      <div className="max-w-4xl mx-auto">
        <button onClick={() => setScreen('menu')} className="mb-6 px-4 py-2 bg-white rounded-lg shadow-lg hover:scale-105 transition">
          <Home className="inline mr-2" />Volver
        </button>
        <div className="bg-white/90 rounded-xl p-8 shadow-xl">
          <h2 className="text-4xl font-bold mb-6 text-center">Tienda de Velocidad</h2>
          <div className="flex justify-center mb-8 text-2xl font-bold">
            <Star className="inline text-yellow-500 mr-2" />{coins} Monedas
          </div>
          <div className="grid gap-4">
            {SPEED_UPGRADES.slice(1).map(u => (
              <div key={u.level} className={`p-6 rounded-xl border-4 ${speed >= u.level ? 'bg-green-100 border-green-500' : 'bg-white border-gray-300'}`}>
                <div className="flex justify-between items-center">
                  <div>
                    <h3 className="text-2xl font-bold">Velocidad Nivel {u.level}</h3>
                    <p className="text-gray-600">Velocidad: {u.speed}x</p>
                  </div>
                  {speed >= u.level ? (
                    <span className="text-green-600 font-bold text-xl">✓ Comprado</span>
                  ) : (
                    <button onClick={buySpeed} disabled={coins < u.cost || speed !== u.level - 1} className={`px-6 py-3 rounded-lg font-bold text-white ${coins >= u.cost && speed === u.level - 1 ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400'}`}>
                      {u.cost} monedas
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-400 to-pink-500 p-8">
      <div className="max-w-4xl mx-auto">
        <button onClick={() => setScreen('menu')} className="mb-6 px-4 py-2 bg-white rounded-lg shadow-lg hover:scale-105 transition">
          <Home className="inline mr-2" />Volver
        </button>
        <div className="bg-white/90 rounded-xl p-8 shadow-xl">
          <h2 className="text-4xl font-bold mb-6 text-center">Mascotas</h2>
          <div className="flex justify-center mb-8 text-2xl font-bold">
            <Star className="inline text-yellow-500 mr-2" />{coins} Monedas
          </div>
          <div className="grid grid-cols-2 gap-6">
            {PETS.map(p => {
              const Icon = p.icon;
              const owned = pets.includes(p.id);
              const equipped = equippedPet === p.id;
              return (
                <div key={p.id} className={`p-6 rounded-xl border-4 ${equipped ? 'bg-yellow-100 border-yellow-500' : owned ? 'bg-green-100 border-green-500' : 'bg-white border-gray-300'}`}>
                  <div className="text-center">
                    <Icon size={64} className="mx-auto mb-4" />
                    <h3 className="text-2xl font-bold mb-2">{p.name}</h3>
                    <p className="text-gray-600 mb-4">+{(p.speedBoost * 100).toFixed(0)}% velocidad</p>
                    {owned ? (
                      <button onClick={() => setEquippedPet(equipped ? null : p.id)} className={`w-full py-3 rounded-lg font-bold text-white ${equipped ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}`}>
                        {equipped ? 'Desequipar' : 'Equipar'}
                      </button>
                    ) : (
                      <button onClick={() => buyPet(p.id)} disabled={coins < p.cost} className={`w-full py-3 rounded-lg font-bold text-white ${coins >= p.cost ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400'}`}>
                        Comprar: {p.cost} monedas
                      </button>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  );
};

export default RobloxObbyGame;
