import React, { useState, useEffect, useRef } from 'react';
import { Trophy, Zap, Star, ShoppingBag, Home, Play, Crown, Rabbit, Cat, Dog, Bird } from 'lucide-react';

const RobloxObbyGame = () => {
  const [screen, setScreen] = useState('menu');
  const [coins, setCoins] = useState(0);
  const [wins, setWins] = useState(0);
  const [speed, setSpeed] = useState(1);
  const [selectedObby, setSelectedObby] = useState(null);
  const [pets, setPets] = useState([]);
  const [equippedPet, setEquippedPet] = useState(null);
  
  // Game state
  const [playerPos, setPlayerPos] = useState({ x: 50, y: 450 });
  const [isJumping, setIsJumping] = useState(false);
  const [velocity, setVelocity] = useState({ x: 0, y: 0 });
  const [currentStage, setCurrentStage] = useState(0);
  const [gameActive, setGameActive] = useState(false);
  const [gameTime, setGameTime] = useState(0);
  
  const canvasRef = useRef(null);
  const keysPressed = useRef({});

  const OBBYS = [
    {
      id: 1,
      name: "Obby Clásico",
      difficulty: "Fácil",
      reward: 50,
      color: "#4CAF50",
      stages: [
        { x: 0, y: 450, width: 100, height: 50, color: "#8BC34A" },
        { x: 150, y: 400, width: 100, height: 50, color: "#8BC34A" },
        { x: 300, y: 350, width: 100, height: 50, color: "#8BC34A" },
        { x: 450, y: 300, width: 100, height: 50, color: "#8BC34A" },
        { x: 600, y: 250, width: 100, height: 50, color: "#FFD700" }
      ]
    },
    {
      id: 2,
      name: "Obby de Lava",
      difficulty: "Medio",
      reward: 100,
      color: "#FF5722",
      stages: [
        { x: 0, y: 450, width: 80, height: 50, color: "#FF7043" },
        { x: 120, y: 450, width: 80, height: 50, color: "#FF7043" },
        { x: 240, y: 400, width: 80, height: 50, color: "#FF7043" },
        { x: 360, y: 350, width: 80, height: 50, color: "#FF7043" },
        { x: 480, y: 300, width: 80, height: 50, color: "#FF7043" },
        { x: 600, y: 250, width: 80, height: 50, color: "#FFD700" }
      ]
    },
    {
      id: 3,
      name: "Obby Espacial",
      difficulty: "Difícil",
      reward: 200,
      color: "#9C27B0",
      stages: [
        { x: 0, y: 450, width: 70, height: 40, color: "#BA68C8" },
        { x: 110, y: 400, width: 70, height: 40, color: "#BA68C8" },
        { x: 220, y: 350, width: 70, height: 40, color: "#BA68C8" },
        { x: 330, y: 300, width: 70, height: 40, color: "#BA68C8" },
        { x: 440, y: 250, width: 70, height: 40, color: "#BA68C8" },
        { x: 550, y: 200, width: 70, height: 40, color: "#BA68C8" },
        { x: 660, y: 150, width: 70, height: 40, color: "#FFD700" }
      ]
    },
    {
      id: 4,
      name: "Obby Extremo",
      difficulty: "Experto",
      reward: 500,
      color: "#F44336",
      stages: [
        { x: 0, y: 450, width: 60, height: 35, color: "#EF5350" },
        { x: 100, y: 420, width: 60, height: 35, color: "#EF5350" },
        { x: 200, y: 380, width: 60, height: 35, color: "#EF5350" },
        { x: 300, y: 340, width: 60, height: 35, color: "#EF5350" },
        { x: 400, y: 300, width: 60, height: 35, color: "#EF5350" },
        { x: 500, y: 250, width: 60, height: 35, color: "#EF5350" },
        { x: 600, y: 200, width: 60, height: 35, color: "#EF5350" },
        { x: 680, y: 150, width: 60, height: 35, color: "#FFD700" }
      ]
    }
  ];

  const PETS = [
    { id: 1, name: "Conejo", icon: Rabbit, cost: 100, speedBoost: 0.2 },
    { id: 2, name: "Gato", icon: Cat, cost: 250, speedBoost: 0.5 },
    { id: 3, name: "Perro", icon: Dog, cost: 500, speedBoost: 0.8 },
    { id: 4, name: "Pájaro", icon: Bird, cost: 1000, speedBoost: 1.2 }
  ];

  const SPEED_UPGRADES = [
    { level: 1, cost: 0, speed: 1 },
    { level: 2, cost: 100, speed: 1.2 },
    { level: 3, cost: 300, speed: 1.5 },
    { level: 4, cost: 600, speed: 1.8 },
    { level: 5, cost: 1000, speed: 2.2 }
  ];

  useEffect(() => {
    if (!gameActive) return;

    const timer = setInterval(() => {
      setGameTime(t => t + 0.016);
    }, 16);

    return () => clearInterval(timer);
  }, [gameActive]);

  useEffect(() => {
    if (!gameActive || !selectedObby) return;

    const handleKeyDown = (e) => {
      keysPressed.current[e.key] = true;
    };

    const handleKeyUp = (e) => {
      keysPressed.current[e.key] = false;
    };

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);

    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
    };
  }, [gameActive, selectedObby]);

  useEffect(() => {
    if (!gameActive || !selectedObby) return;

    const gameLoop = setInterval(() => {
      setPlayerPos(prev => {
        let newX = prev.x;
        let newY = prev.y;
        let newVelY = velocity.y;

        const totalSpeed = speed * (equippedPet ? 1 + PETS.find(p => p.id === equippedPet)?.speedBoost : 1);
        const moveSpeed = 3 * totalSpeed;

        if (keysPressed.current['ArrowLeft'] || keysPressed.current['a']) {
          newX -= moveSpeed;
        }
        if (keysPressed.current['ArrowRight'] || keysPressed.current['d']) {
          newX += moveSpeed;
        }
        if ((keysPressed.current['ArrowUp'] || keysPressed.current['w'] || keysPressed.current[' ']) && !isJumping) {
          newVelY = -12;
          setIsJumping(true);
        }

        newY += newVelY;
        newVelY += 0.5; // Gravedad

        const obby = OBBYS.find(o => o.id === selectedObby);
        let onPlatform = false;

        obby.stages.forEach((stage, idx) => {
          if (newX + 20 > stage.x && newX < stage.x + stage.width &&
              newY + 20 >= stage.y && newY + 20 <= stage.y + stage.height &&
              newVelY >= 0) {
            newY = stage.y - 20;
            newVelY = 0;
            onPlatform = true;
            setIsJumping(false);
            
            if (idx > currentStage) {
              setCurrentStage(idx);
            }

            if (idx === obby.stages.length - 1) {
              setTimeout(() => {
                completeObby();
              }, 100);
            }
          }
        });

        if (newY > 500) {
          return { x: 50, y: 450 };
        }

        newX = Math.max(0, Math.min(750, newX));

        setVelocity({ x: 0, y: newVelY });
        return { x: newX, y: newY };
      });
    }, 16);

    return () => clearInterval(gameLoop);
  }, [gameActive, selectedObby, velocity, isJumping, currentStage, speed, equippedPet]);

  useEffect(() => {
    if (!canvasRef.current || !selectedObby) return;

    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    
    ctx.clearRect(0, 0, 800, 500);

    const obby = OBBYS.find(o => o.id === selectedObby);
    
    ctx.fillStyle = '#87CEEB';
    ctx.fillRect(0, 0, 800, 500);

    obby.stages.forEach((stage, idx) => {
      ctx.fillStyle = stage.color;
      ctx.fillRect(stage.x, stage.y, stage.width, stage.height);
      
      ctx.fillStyle = '#000';
      ctx.font = '12px Arial';
      ctx.fillText(`${idx + 1}`, stage.x + stage.width/2 - 5, stage.y + stage.height/2 + 5);
    });

    ctx.fillStyle = '#2196F3';
    ctx.fillRect(playerPos.x, playerPos.y, 20, 20);

    if (equippedPet) {
      ctx.fillStyle = '#FFB6C1';
      ctx.beginPath();
      ctx.arc(playerPos.x + 30, playerPos.y + 10, 8, 0, Math.PI * 2);
      ctx.fill();
    }

  }, [playerPos, selectedObby, equippedPet]);

  const startObby = (obbyId) => {
    setSelectedObby(obbyId);
    setPlayerPos({ x: 50, y: 450 });
    setVelocity({ x: 0, y: 0 });
    setCurrentStage(0);
    setGameActive(true);
    setGameTime(0);
    setScreen('game');
  };

  const completeObby = () => {
    const obby = OBBYS.find(o => o.id === selectedObby);
    const reward = Math.floor(obby.reward * (1 + (equippedPet ? PETS.find(p => p.id === equippedPet)?.speedBoost * 0.5 : 0)));
    
    setCoins(c => c + reward);
    setWins(w => w + 1);
    setGameActive(false);
    
    alert(`¡Obby completado! +${reward} monedas`);
    setScreen('menu');
  };

  const buySpeedUpgrade = () => {
    const nextLevel = speed + 1;
    const upgrade = SPEED_UPGRADES.find(u => u.level === nextLevel);
    
    if (upgrade && coins >= upgrade.cost) {
      setCoins(c => c - upgrade.cost);
      setSpeed(upgrade.level);
    }
  };

  const buyPet = (petId) => {
    const pet = PETS.find(p => p.id === petId);
    if (coins >= pet.cost && !pets.includes(petId)) {
      setCoins(c => c - pet.cost);
      setPets(p => [...p, petId]);
    }
  };

  const renderMenu = () => (
    <div className="min-h-screen bg-gradient-to-br from-blue-400 via-purple-500 to-pink-500 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="text-center mb-8">
          <h1 className="text-6xl font-bold text-white mb-4 drop-shadow-lg">OBBY GAME</h1>
          <div className="flex justify-center gap-8 text-white text-xl">
            <div className="flex items-center gap-2 bg-black/30 px-4 py-2 rounded-full">
              <Star className="text-yellow-300" />
              <span>{coins} Monedas</span>
            </div>
            <div className="flex items-center gap-2 bg-black/30 px-4 py-2 rounded-full">
              <Trophy className="text-yellow-300" />
              <span>{wins} Victorias</span>
            </div>
            <div className="flex items-center gap-2 bg-black/30 px-4 py-2 rounded-full">
              <Zap className="text-yellow-300" />
              <span>Velocidad: {speed}x</span>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-2 gap-4 mb-6">
          {OBBYS.map(obby => (
            <div key={obby.id} className="bg-white/90 rounded-xl p-6 shadow-xl">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-2xl font-bold" style={{ color: obby.color }}>{obby.name}</h3>
                <span className="px-3 py-1 bg-gray-200 rounded-full text-sm">{obby.difficulty}</span>
              </div>
              <p className="text-gray-700 mb-4">Recompensa: {obby.reward} monedas</p>
              <button
                onClick={() => startObby(obby.id)}
                className="w-full py-3 rounded-lg font-bold text-white transition hover:scale-105"
                style={{ backgroundColor: obby.color }}
              >
                <Play className="inline mr-2" size={20} />
                Jugar
              </button>
            </div>
          ))}
        </div>

        <div className="flex gap-4">
          <button
            onClick={() => setScreen('shop')}
            className="flex-1 bg-white/90 rounded-xl p-6 shadow-xl hover:scale-105 transition"
          >
            <ShoppingBag className="mx-auto mb-2 text-green-500" size={40} />
            <h3 className="text-xl font-bold text-center">Tienda</h3>
          </button>
          <button
            onClick={() => setScreen('pets')}
            className="flex-1 bg-white/90 rounded-xl p-6 shadow-xl hover:scale-105 transition"
          >
            <Crown className="mx-auto mb-2 text-purple-500" size={40} />
            <h3 className="text-xl font-bold text-center">Mascotas</h3>
          </button>
        </div>
      </div>
    </div>
  );

  const renderGame = () => (
    <div className="min-h-screen bg-gradient-to-br from-gray-800 to-gray-900 p-8">
      <div className="max-w-4xl mx-auto">
        <div className="bg-white/90 rounded-xl p-4 mb-4">
          <div className="flex justify-between items-center">
            <h2 className="text-2xl font-bold">{OBBYS.find(o => o.id === selectedObby)?.name}</h2>
            <div className="flex gap-4">
              <span>Etapa: {currentStage + 1}/{OBBYS.find(o => o.id === selectedObby)?.stages.length}</span>
              <span>Tiempo: {gameTime.toFixed(1)}s</span>
            </div>
            <button
              onClick={() => {
                setGameActive(false);
                setScreen('menu');
              }}
              className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
            >
              Salir
            </button>
          </div>
        </div>
        
        <div className="bg-white rounded-xl p-4 shadow-xl">
          <canvas
            ref={canvasRef}
            width={800}
            height={500}
            className="w-full border-4 border-gray-300 rounded-lg"
          />
          <div className="mt-4 text-center text-gray-700">
            <p className="font-bold">Controles: ← → o A D para mover | ↑ W o ESPACIO para saltar</p>
          </div>
        </div>
      </div>
    </div>
  );

  const renderShop = () => (
    <div className="min-h-screen bg-gradient-to-br from-green-400 to-blue-500 p-8">
      <div className="max-w-4xl mx-auto">
        <button
          onClick={() => setScreen('menu')}
          className="mb-6 px-4 py-2 bg-white rounded-lg shadow-lg hover:scale-105 transition"
        >
          <Home className="inline mr-2" />
          Volver
        </button>

        <div className="bg-white/90 rounded-xl p-8 shadow-xl">
          <h2 className="text-4xl font-bold mb-6 text-center">Tienda de Velocidad</h2>
          <div className="flex justify-center mb-8">
            <div className="text-2xl font-bold">
              <Star className="inline text-yellow-500 mr-2" />
              {coins} Monedas
            </div>
          </div>

          <div className="grid grid-cols-1 gap-4">
            {SPEED_UPGRADES.slice(1).map(upgrade => (
              <div key={upgrade.level} className={`p-6 rounded-xl border-4 ${speed >= upgrade.level ? 'bg-green-100 border-green-500' : 'bg-white border-gray-300'}`}>
                <div className="flex justify-between items-center">
                  <div>
                    <h3 className="text-2xl font-bold">Velocidad Nivel {upgrade.level}</h3>
                    <p className="text-gray-600">Velocidad: {upgrade.speed}x</p>
                  </div>
                  <div>
                    {speed >= upgrade.level ? (
                      <span className="text-green-600 font-bold text-xl">✓ Comprado</span>
                    ) : (
                      <button
                        onClick={() => buySpeedUpgrade()}
                        disabled={coins < upgrade.cost || speed !== upgrade.level - 1}
                        className={`px-6 py-3 rounded-lg font-bold text-white ${
                          coins >= upgrade.cost && speed === upgrade.level - 1
                            ? 'bg-green-500 hover:bg-green-600'
                            : 'bg-gray-400 cursor-not-allowed'
                        }`}
                      >
                        {upgrade.cost} monedas
                      </button>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );

  const renderPets = () => (
    <div className="min-h-screen bg-gradient-to-br from-purple-400 to-pink-500 p-8">
      <div className="max-w-4xl mx-auto">
        <button
          onClick={() => setScreen('menu')}
          className="mb-6 px-4 py-2 bg-white rounded-lg shadow-lg hover:scale-105 transition"
        >
          <Home className="inline mr-2" />
          Volver
        </button>

        <div className="bg-white/90 rounded-xl p-8 shadow-xl">
          <h2 className="text-4xl font-bold mb-6 text-center">Mascotas</h2>
          <div className="flex justify-center mb-8">
            <div className="text-2xl font-bold">
              <Star className="inline text-yellow-500 mr-2" />
              {coins} Monedas
            </div>
          </div>

          <div className="grid grid-cols-2 gap-6">
            {PETS.map(pet => {
              const Icon = pet.icon;
              const owned = pets.includes(pet.id);
              const equipped = equippedPet === pet.id;

              return (
                <div key={pet.id} className={`p-6 rounded-xl border-4 ${equipped ? 'bg-yellow-100 border-yellow-500' : owned ? 'bg-green-100 border-green-500' : 'bg-white border-gray-300'}`}>
                  <div className="text-center">
                    <Icon size={64} className="mx-auto mb-4" />
                    <h3 className="text-2xl font-bold mb-2">{pet.name}</h3>
                    <p className="text-gray-600 mb-4">+{(pet.speedBoost * 100).toFixed(0)}% velocidad</p>
                    
                    {owned ? (
                      <button
                        onClick={() => setEquippedPet(equipped ? null : pet.id)}
                        className={`w-full py-3 rounded-lg font-bold text-white ${
                          equipped ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'
                        }`}
                      >
                        {equipped ? 'Desequipar' : 'Equipar'}
                      </button>
                    ) : (
                      <button
                        onClick={() => buyPet(pet.id)}
                        disabled={coins < pet.cost}
                        className={`w-full py-3 rounded-lg font-bold text-white ${
                          coins >= pet.cost ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400 cursor-not-allowed'
                        }`}
                      >
                        Comprar: {pet.cost} monedas
                      </button>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  );

  return (
    <>
      {screen === 'menu' && renderMenu()}
      {screen === 'game' && renderGame()}
      {screen === 'shop' && renderShop()}
      {screen === 'pets' && renderPets()}
    </>
  );
};

export default RobloxObbyGame;
