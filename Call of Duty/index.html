<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Warzone JS: Training Ground</title>
    <style>
        :root { --cod-orange: #ff9d00; --cod-bg: #0a0a0a; --ui-panel: rgba(0,0,0,0.85); }
        body { margin: 0; overflow: hidden; background: var(--cod-bg); font-family: 'Arial Black', sans-serif; color: white; }
        
        /* --- LOBBY & TIENDA --- */
        #ui-overlay {
            position: absolute; width: 100%; height: 100%; z-index: 20;
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.9));
            display: flex; flex-direction: column; justify-content: center; padding-left: 5%;
        }
        .menu-btn {
            font-size: 35px; cursor: pointer; margin: 10px 0; transition: 0.2s;
            color: #888; text-transform: uppercase;
        }
        .menu-btn:hover { color: white; transform: translateX(15px); }
        .active { color: var(--cod-orange); }

        #shop-panel {
            display: none; position: absolute; right: 5%; top: 20%;
            width: 300px; background: var(--ui-panel); border: 2px solid var(--cod-orange); padding: 20px;
        }

        /* --- HUD --- */
        #game-ui { display: none; pointer-events: none; }
        #hud-bottom {
            position: absolute; bottom: 30px; width: 100%; display: flex;
            justify-content: space-between; padding: 0 50px; box-sizing: border-box;
        }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 24px; height: 24px;
            transform: translate(-50%, -50%); border: 2px solid rgba(255,255,255,0.4); border-radius: 50%;
        }
        .stat-box { background: rgba(0,0,0,0.5); padding: 10px 20px; border-left: 4px solid var(--cod-orange); }
        .currency { color: var(--cod-orange); font-size: 24px; }
    </style>
</head>
<body>

<div id="ui-overlay">
    <h1 style="font-size: 60px; margin: 0;">WARZONE <span style="color:var(--cod-orange)">JS</span></h1>
    <div id="wallet-display" class="currency" style="margin-bottom: 20px;">CALL BUCKS: 0</div>
    
    <div class="menu-btn active" onclick="deploy()">DESPLEGAR EN ENTRENAMIENTO</div>
    <div class="menu-btn" onclick="toggleShop()">TIENDA DE ARMAS</div>
    <div class="menu-btn" onclick="location.reload()">SALIR</div>

    <div id="shop-panel">
        <h3>SUMINISTROS</h3>
        <p>Subfusil MP5 - <span class="currency">500 CB</span> <button onclick="buyWeapon('MP5', 500)">COMPRAR</button></p>
        <p>Francotirador - <span class="currency">1200 CB</span> <button onclick="buyWeapon('SNIPER', 1200)">COMPRAR</button></p>
        <button onclick="toggleShop()" style="margin-top:10px;">CERRAR</button>
    </div>
</div>

<div id="game-ui">
    <div id="crosshair"></div>
    <div id="hud-bottom">
        <div class="stat-box">
            <div id="weapon-name">RIFLE ASALTO</div>
            <div id="ammo" style="font-size: 40px;">30 / 30</div>
        </div>
        <div class="stat-box">
            <div style="font-size: 12px;">CRÉDITOS</div>
            <div id="ingame-cash" class="currency">0</div>
        </div>
    </div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    let scene, camera, renderer, weapon, raycaster;
    let callBucks = 1000;
    let ammo = 30, isReloading = false, isFiring = false;
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
    let enemies = [];
    let velocity = new THREE.Vector3();

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.Fog(0x111111, 0, 100);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        // Zona de Entrenamiento: Suelo de hormigón
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(200, 200),
            new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.8 })
        );
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5), new THREE.DirectionalLight(0xffffff, 1));

        // Arma
        weapon = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.2, 0.8), new THREE.MeshStandardMaterial({color: 0x222222}));
        weapon.add(body);
        weapon.position.set(0.4, -0.4, -0.6);
        camera.add(weapon);
        scene.add(camera);

        // Dianas de entrenamiento
        for(let i=0; i<10; i++) spawnTarget();

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        setupControls();
        animate();
    }

    function setupControls() {
        document.addEventListener('keydown', (e) => {
            switch(e.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyD': moveRight = true; break;
                case 'KeyR': reload(); break;
            }
        });
        document.addEventListener('keyup', (e) => {
            switch(e.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyD': moveRight = false; break;
            }
        });
        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement) {
                camera.rotation.y -= e.movementX * 0.002;
                camera.rotation.x -= e.movementY * 0.002;
                camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
            }
        });
        window.addEventListener('mousedown', (e) => { if(e.button===0) isFiring=true; if(e.button===2) zoom(true); });
        window.addEventListener('mouseup', (e) => { if(e.button===0) isFiring=false; if(e.button===2) zoom(false); });
        
        raycaster = new THREE.Raycaster();
        document.oncontextmenu = () => false;
    }

    function spawnTarget() {
        const target = new THREE.Mesh(
            new THREE.CylinderGeometry(0.5, 0.5, 0.1, 32),
            new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xff0000, emissiveIntensity: 0.2 })
        );
        target.rotation.x = Math.PI/2;
        target.position.set(Math.random()*40-20, 1.5, Math.random()*-50-5);
        scene.add(target);
        enemies.push(target);
    }

    window.deploy = function() {
        document.getElementById('ui-overlay').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        document.body.requestPointerLock();
        if(!renderer) init();
    }

    window.toggleShop = function() {
        const shop = document.getElementById('shop-panel');
        shop.style.display = shop.style.display === 'block' ? 'none' : 'block';
    }

    window.buyWeapon = function(name, cost) {
        if(callBucks >= cost) {
            callBucks -= cost;
            document.getElementById('wallet-display').innerText = `CALL BUCKS: ${callBucks}`;
            document.getElementById('weapon-name').innerText = name;
            alert(`Compraste ${name}!`);
        } else {
            alert("No tienes suficientes Call Bucks");
        }
    }

    function shoot() {
        if (ammo <= 0 || isReloading) return;
        ammo--;
        updateHUD();
        
        raycaster.setFromCamera({x:0, y:0}, camera);
        const hits = raycaster.intersectObjects(enemies);
        if(hits.length > 0) {
            scene.remove(hits[0].object);
            enemies = enemies.filter(e => e !== hits[0].object);
            callBucks += 50; // Recompensa por tiro
            updateHUD();
            setTimeout(spawnTarget, 1000);
        }
    }

    function updateHUD() {
        document.getElementById('ammo').innerText = `${ammo} / 30`;
        document.getElementById('ingame-cash').innerText = callBucks;
        document.getElementById('wallet-display').innerText = `CALL BUCKS: ${callBucks}`;
    }

    function zoom(active) { camera.fov = active ? 40 : 75; camera.updateProjectionMatrix(); }

    function reload() {
        if(isReloading) return;
        isReloading = true;
        setTimeout(() => { ammo = 30; isReloading = false; updateHUD(); }, 1500);
    }

    function animate() {
        requestAnimationFrame(animate);
        
        if (document.pointerLockElement) {
            const speed = 0.15;
            if (moveForward) camera.translateZ(-speed);
            if (moveBackward) camera.translateZ(speed);
            if (moveLeft) camera.translateX(-speed);
            if (moveRight) camera.translateX(speed);
            camera.position.y = 1.7; // Mantener altura de ojos
        }

        if (isFiring && Math.random() > 0.8) shoot(); // Simulación ráfaga
        if(renderer) renderer.render(scene, camera);
    }
</script>
</body>
</html>
