<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Warzone JS - Survival Training</title>
    <style>
        :root { --cod-orange: #ff9d00; --cod-bg: #0a0a0a; }
        body { margin: 0; overflow: hidden; background: var(--cod-bg); font-family: 'Arial Black', sans-serif; color: white; }
        
        /* LOBBY */
        #lobby {
            position: absolute; width: 100%; height: 100%; z-index: 20;
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1552820728-8b83bb6b773f?q=80&w=2000');
            background-size: cover; display: flex; flex-direction: column; justify-content: center; padding-left: 8%;
        }
        .menu-item { font-size: 40px; color: #666; cursor: pointer; margin: 15px 0; transition: 0.3s; font-style: italic; }
        .menu-item:hover { color: white; transform: translateX(20px); text-shadow: 0 0 15px var(--cod-orange); }
        .active-menu { color: var(--cod-orange); border-left: 5px solid var(--cod-orange); padding-left: 15px; }

        /* HUD JUEGO */
        #game-ui { display: none; pointer-events: none; }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 15px; height: 15px;
            border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; transform: translate(-50%, -50%);
        }
        #hud-bottom {
            position: absolute; bottom: 40px; right: 40px; text-align: right;
        }
        #health-bar-container {
            position: absolute; bottom: 40px; left: 40px; width: 300px; height: 10px; background: rgba(255,255,255,0.2);
        }
        #health-bar { width: 100%; height: 100%; background: #00ff00; transition: 0.2s; }
        .stat { font-size: 50px; font-weight: 900; }
        .currency { color: var(--cod-orange); font-size: 20px; }
    </style>
</head>
<body>

<div id="lobby">
    <h1 style="font-size: 70px; margin: 0;">WARZONE <span style="color:var(--cod-orange)">JS</span></h1>
    <div id="lb-money" class="currency" style="font-size: 30px; margin-bottom: 30px;">CALL BUCKS: 1000</div>
    <div class="menu-item active-menu" onclick="startGame()">DESPLEGAR</div>
    <div class="menu-item">TIENDA (SHOP)</div>
    <div class="menu-item" onclick="location.reload()">SALIR</div>
</div>

<div id="game-ui">
    <div id="crosshair"></div>
    <div id="health-bar-container"><div id="health-bar"></div></div>
    <div id="hud-bottom">
        <div class="currency">CALL BUCKS: <span id="ingame-money">1000</span></div>
        <div id="ammo" class="stat">30 / 30</div>
        <div id="weapon-name" style="color: var(--cod-orange);">M4 CARBINE</div>
    </div>
</div>

<script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    let scene, camera, renderer, weapon, raycaster;
    let playerHealth = 100, callBucks = 1000, ammo = 30, isReloading = false;
    let enemies = [], moveKeys = {w:false, a:false, s:false, d:false};
    let isFiring = false, lastFire = 0;

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0a);
        scene.fog = new THREE.Fog(0x0a0a0a, 0, 50);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        
        // Suelo
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({color: 0x151515}));
        floor.rotation.x = -Math.PI/2;
        scene.add(floor);
        scene.add(new THREE.AmbientLight(0xffffff, 0.3), new THREE.DirectionalLight(0xffffff, 0.8));

        // Arma
        weapon = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.2, 0.7), new THREE.MeshStandardMaterial({color: 0x000000}));
        weapon.add(body);
        weapon.position.set(0.3, -0.3, -0.5);
        camera.add(weapon);
        scene.add(camera);

        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        setupEventListeners();
    }

    function spawnEnemy() {
        const group = new THREE.Group();
        // Cuerpo humanoide simple
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1.2, 0.3), new THREE.MeshStandardMaterial({color: 0xff0000}));
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.3), new THREE.MeshStandardMaterial({color: 0xffaaaa}));
        head.position.y = 0.8;
        group.add(body, head);
        
        group.position.set(Math.random()*40-20, 1, Math.random()*-40 - 10);
        group.userData = { health: 100, lastShot: 0 };
        scene.add(group);
        enemies.push(group);
    }

    function setupEventListeners() {
        document.addEventListener('keydown', e => moveKeys[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', e => moveKeys[e.key.toLowerCase()] = false);
        document.addEventListener('mousemove', e => {
            if(document.pointerLockElement) {
                camera.rotation.y -= e.movementX * 0.002;
                camera.rotation.x -= e.movementY * 0.002;
                camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));
            }
        });
        window.addEventListener('mousedown', e => { 
            if(e.button === 0) isFiring = true;
            if(e.button === 2) { camera.fov = 40; camera.updateProjectionMatrix(); weapon.position.x = 0; }
        });
        window.addEventListener('mouseup', e => { 
            if(e.button === 0) isFiring = false;
            if(e.button === 2) { camera.fov = 75; camera.updateProjectionMatrix(); weapon.position.x = 0.3; }
        });
        raycaster = new THREE.Raycaster();
    }

    window.startGame = function() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        document.body.requestPointerLock();
        if(!renderer) {
            init();
            for(let i=0; i<5; i++) spawnEnemy();
            animate();
        }
    }

    function shoot() {
        if(ammo <= 0 || isReloading) return;
        ammo--;
        document.getElementById('ammo').innerText = `${ammo} / 30`;
        
        // Retroceso
        weapon.position.z += 0.05;
        setTimeout(() => weapon.position.z -= 0.05, 50);

        raycaster.setFromCamera({x:0,y:0}, camera);
        const hits = raycaster.intersectObjects(enemies, true);
        if(hits.length > 0) {
            let enemyObj = hits[0].object.parent;
            enemyObj.userData.health -= 35;
            if(enemyObj.userData.health <= 0) {
                scene.remove(enemyObj);
                enemies = enemies.filter(e => e !== enemyObj);
                callBucks += 150;
                document.getElementById('ingame-money').innerText = callBucks;
                setTimeout(spawnEnemy, 2000);
            }
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        const time = performance.now();

        if(document.pointerLockElement) {
            // Movimiento Jugador
            const speed = 0.12;
            if(moveKeys.w) camera.translateZ(-speed);
            if(moveKeys.s) camera.translateZ(speed);
            if(moveKeys.a) camera.translateX(-speed);
            if(moveKeys.d) camera.translateX(speed);
            camera.position.y = 1.7;

            // Disparo automático
            if(isFiring && time - lastFire > 120) {
                shoot();
                lastFire = time;
            }

            // IA Enemiga
            enemies.forEach(en => {
                // Perseguir al jugador
                const dir = new THREE.Vector3().subVectors(camera.position, en.position).normalize();
                en.position.add(dir.multiplyScalar(0.04));
                en.lookAt(camera.position.x, 1, camera.position.z);

                // El enemigo dispara si está cerca
                if(en.position.distanceTo(camera.position) < 15 && time - en.userData.lastShot > 1500) {
                    playerHealth -= 10;
                    document.getElementById('health-bar').style.width = playerHealth + "%";
                    en.userData.lastShot = time;
                    if(playerHealth <= 0) location.reload(); // Muerte
                }
            });
        }
        renderer.render(scene, camera);
    }
</script>
</body>
</html>
