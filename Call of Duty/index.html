<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>FPS Realista - Pro Movement</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{overflow:hidden;background:#000;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
    canvas{display:block}

    #hud{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none; display:none;}
    #crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:24px;opacity: 0.8;}
    .panel{position:absolute;background:rgba(0,0,0,0.5);padding:10px 20px;border-radius:5px;backdrop-filter: blur(5px);border-left: 4px solid}
    #ammo{bottom:30px;right:30px;color:#0ff;border-color:#0ff}
    #health{bottom:30px;left:30px;color:#f33;border-color:#f33}
    #kills{top:30px;left:30px;color:#fb1;border-color:#fb1}

    #menu, #gameover{
        position:fixed;top:0;left:0;width:100%;height:100%;
        display:flex;align-items:center;justify-content:center;
        flex-direction:column;background:radial-gradient(circle, #222 0%, #000 100%);color:#fff;z-index:10
    }
    h1{font-size: 3rem; margin-bottom: 20px; letter-spacing: 5px;}
    button{padding:15px 50px;font-size:18px;text-transform:uppercase;cursor:pointer;background:#fff;border:none;transition:0.3s}
    button:hover{background:#fb1; transform: scale(1.1);}
    p{margin-top: 20px; color: #aaa;}
</style>
</head>

<body>

<div id="menu">
    <h1>URBAN OPS</h1>
    <button onclick="startGame()">DESPLEGAR</button>
    <p>MAYÚS: Correr | CTRL: Deslizarse | WASD: Mover | CLICK: Disparar</p>
</div>

<div id="gameover" style="display:none">
    <h1>MISIÓN FALLIDA</h1>
    <p id="final"></p>
    <button onclick="location.reload()">REINTENTAR</button>
</div>

<div id="hud">
    <div id="crosshair">·</div>
    <div id="ammo" class="panel">MUNICIÓN: <span id="ammoVal">30</span></div>
    <div id="health" class="panel">ESTADO: <span id="healthVal">100</span>%</div>
    <div id="kills" class="panel">ELIMINACIONES: <span id="killVal">0</span></div>
</div>

<canvas id="c"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
let scene, camera, renderer, clock;
let yaw = new THREE.Object3D();
let pitch = new THREE.Object3D();
let raycaster = new THREE.Raycaster();

let player = {
    health: 100, ammo: 30, kills: 0,
    velocityY: 0, onGround: true,
    height: 1.7, speed: 0.15,
    isSliding: false, slideVec: new THREE.Vector3(), slideTimer: 0
};

let enemies = [];
let keys = {};
let mouseMove = {x: 0, y: 0};
let playing = false;
let weapon;
const GRAVITY = 0.009;

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x11141a);
    scene.fog = new THREE.Fog(0x11141a, 2, 40);
    clock = new THREE.Clock();

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    
    yaw.position.y = player.height;
    yaw.add(pitch);
    pitch.add(camera);
    scene.add(yaw);

    renderer = new THREE.WebGLRenderer({canvas: c, antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;

    // Iluminación
    scene.add(new THREE.AmbientLight(0x404040, 0.5));
    let sun = new THREE.PointLight(0xffffff, 1, 100);
    sun.position.set(10, 20, 10);
    scene.add(sun);

    createMap();
    createWeapon();

    // Eventos
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);
    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mousedown', shoot);
    window.addEventListener('resize', onResize);

    // Pointer Lock robusto
    document.addEventListener('pointerlockchange', () => {
        if (document.pointerLockElement !== document.body) {
            playing = false;
            menu.style.display = 'flex';
            hud.style.display = 'none';
        }
    });

    animate();
}

function createMap() {
    // Suelo con rejilla
    let grid = new THREE.GridHelper(200, 50, 0xff0000, 0x222222);
    scene.add(grid);

    let floorGeo = new THREE.PlaneGeometry(200, 200);
    let floorMat = new THREE.MeshStandardMaterial({color: 0x0a0a0a});
    let floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // Obstáculos (Cajas)
    for(let i=0; i<20; i++) {
        let box = new THREE.Mesh(
            new THREE.BoxGeometry(2, Math.random()*4 + 1, 2),
            new THREE.MeshStandardMaterial({color: 0x333333})
        );
        box.position.set(Math.random()*60-30, 0, Math.random()*60-30);
        box.position.y = box.geometry.parameters.height/2;
        scene.add(box);
    }
}

function createWeapon() {
    weapon = new THREE.Group();
    
    // Cuerpo del arma (M4 Style)
    let body = new THREE.Mesh(
        new THREE.BoxGeometry(0.08, 0.15, 0.6),
        new THREE.MeshStandardMaterial({color: 0x111, metalness: 0.9, roughness: 0.2})
    );
    weapon.add(body);

    let barrel = new THREE.Mesh(
        new THREE.CylinderGeometry(0.02, 0.02, 0.4),
        new THREE.MeshStandardMaterial({color: 0x050505, metalness: 1})
    );
    barrel.rotation.x = Math.PI/2;
    barrel.position.z = -0.5;
    weapon.add(barrel);

    weapon.position.set(0.3, -0.25, -0.5);
    pitch.add(weapon);
}

function onMouseMove(e) {
    if (!playing) return;
    yaw.rotation.y -= e.movementX * 0.002;
    pitch.rotation.x -= e.movementY * 0.002;
    pitch.rotation.x = Math.max(-Math.PI/2.2, Math.min(Math.PI/2.2, pitch.rotation.x));
}

function shoot() {
    if (!playing || player.ammo <= 0) return;
    
    player.ammo--;
    updateHUD();

    // Retroceso visual
    weapon.position.z += 0.05;
    setTimeout(() => weapon.position.z -= 0.05, 50);

    raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
    let targets = enemies.map(e => e.mesh);
    let hits = raycaster.intersectObjects(targets);

    if (hits.length > 0) {
        let hitObj = hits[0].object;
        let enemy = enemies.find(e => e.mesh === hitObj);
        enemy.health -= 35;
        hitObj.material.color.set(0xffffff); // Flash de daño
        setTimeout(() => hitObj.material.color.set(0xaa0000), 100);

        if (enemy.health <= 0) {
            scene.remove(hitObj);
            enemies.splice(enemies.indexOf(enemy), 1);
            player.kills++;
            updateHUD();
            spawnEnemy(); // Spawn infinito
        }
    }
}

function updatePlayer(delta) {
    let currentSpeed = player.speed;
    let isSprinting = keys.ShiftLeft && keys.KeyW;
    let isCrouching = keys.ControlLeft;

    // Lógica de DESLIZAMIENTO (Slide)
    if (isSprinting && isCrouching && !player.isSliding && player.onGround) {
        player.isSliding = true;
        player.slideTimer = 1.0;
        // Dirección del deslizamiento
        player.slideVec.set(0, 0, -1).applyQuaternion(yaw.quaternion);
    }

    if (player.isSliding) {
        yaw.position.add(player.slideVec.clone().multiplyScalar(player.slideTimer * 0.4));
        player.slideTimer -= delta * 1.5;
        yaw.position.y = 0.8; // Altura agachado
        if (player.slideTimer <= 0 || !isCrouching) player.isSliding = false;
    } else {
        // Movimiento normal
        if (isSprinting) currentSpeed *= 1.8;
        if (isCrouching) {
            currentSpeed *= 0.4;
            yaw.position.y = THREE.MathUtils.lerp(yaw.position.y, 0.9, 0.2);
        } else {
            yaw.position.y = THREE.MathUtils.lerp(yaw.position.y, player.height, 0.2);
        }

        let moveX = (keys.KeyD ? 1 : 0) - (keys.KeyA ? 1 : 0);
        let moveZ = (keys.KeyS ? 1 : 0) - (keys.KeyW ? 1 : 0);
        let moveDir = new THREE.Vector3(moveX, 0, moveZ).normalize().applyQuaternion(yaw.quaternion);
        yaw.position.add(moveDir.multiplyScalar(currentSpeed));
    }

    // Salto
    if (keys.Space && player.onGround) {
        player.velocityY = 0.2;
        player.onGround = false;
        player.isSliding = false;
    }

    player.velocityY -= GRAVITY;
    yaw.position.y += player.velocityY;

    if (yaw.position.y <= (isCrouching ? 0.9 : player.height)) {
        player.velocityY = 0;
        player.onGround = true;
        if(!player.isSliding) yaw.position.y = isCrouching ? 0.9 : player.height;
    }

    // Weapon Bobbing (Efecto de caminar)
    let time = clock.getElapsedTime();
    if (player.onGround && (keys.KeyW || keys.KeyS || keys.KeyA || keys.KeyD)) {
        let bob = isSprinting ? 0.05 : 0.02;
        let freq = isSprinting ? 15 : 10;
        weapon.position.y = -0.25 + Math.sin(time * freq) * bob;
        weapon.position.x = 0.3 + Math.cos(time * freq * 0.5) * bob;
    }
}

function spawnEnemy() {
    let eGeo = new THREE.CapsuleGeometry(0.4, 1.2);
    let eMat = new THREE.MeshStandardMaterial({color: 0xaa0000});
    let mesh = new THREE.Mesh(eGeo, eMat);
    
    let angle = Math.random() * Math.PI * 2;
    let dist = 20 + Math.random() * 20;
    mesh.position.set(Math.cos(angle)*dist, 1.2, Math.sin(angle)*dist);
    
    scene.add(mesh);
    enemies.push({mesh, health: 100});
}

function updateEnemies() {
    enemies.forEach(e => {
        let dir = new THREE.Vector3().subVectors(yaw.position, e.mesh.position);
        dir.y = 0;
        let dist = dir.length();
        if (dist > 1.5) {
            e.mesh.position.add(dir.normalize().multiplyScalar(0.06));
            e.mesh.lookAt(yaw.position.x, 1.2, yaw.position.z);
        } else {
            player.health -= 0.5;
            updateHUD();
            if (player.health <= 0) gameOver();
        }
    });
}

function updateHUD() {
    ammoVal.textContent = player.ammo;
    healthVal.textContent = Math.ceil(player.health);
    killVal.textContent = player.kills;
}

function animate() {
    requestAnimationFrame(animate);
    let delta = clock.getDelta();
    
    if (playing) {
        updatePlayer(delta);
        updateEnemies();
    }
    renderer.render(scene, camera);
}

function startGame() {
    menu.style.display = 'none';
    hud.style.display = 'block';
    playing = true;
    player.health = 100;
    player.ammo = 30;
    updateHUD();
    document.body.requestPointerLock();
    if(enemies.length === 0) for(let i=0; i<5; i++) spawnEnemy();
}

function gameOver() {
    playing = false;
    final.textContent = 'ELIMINACIONES TOTALES: ' + player.kills;
    gameover.style.display = 'flex';
    hud.style.display = 'none';
    document.exitPointerLock();
}

function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

window.onload = init;
</script>
</body>
</html>
