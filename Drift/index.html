<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drift Masters Pro</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial Black', sans-serif; background: #87CEEB; }
        #ui { position: absolute; top: 20px; left: 20px; color: white; text-shadow: 3px 3px 0px #000; pointer-events: none; }
        
        /* Bot√≥n Garaje */
        #openShop { position: absolute; bottom: 20px; right: 20px; padding: 15px 30px; background: #f1c40f; border: 4px solid #000; cursor: pointer; font-weight: bold; font-size: 18px; }
        
        /* Cat√°logo */
        #catalog { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); border: 5px solid #f1c40f; padding: 30px; 
            color: white; display: none; text-align: center; border-radius: 20px; min-width: 300px;
        }
        .car-option { border: 2px solid #555; padding: 15px; margin: 10px; cursor: pointer; transition: 0.3s; }
        .car-option:hover { background: #333; border-color: #f1c40f; }
        .close-btn { position: absolute; top: 10px; right: 10px; color: red; cursor: pointer; font-size: 20px; }
        
        #coins-display { color: #f1c40f; font-size: 24px; }
    </style>
</head>
<body>

    <div id="ui">
        <div id="coins-display">üí∞ <span id="coinCount">0</span></div>
        <div style="font-size: 12px;">DERrapa PARA GANAR MONEDAS</div>
    </div>

    <button id="openShop" onclick="toggleCatalog(true)">üèéÔ∏è GARAJE / TIENDA</button>

    <div id="catalog">
        <span class="close-btn" onclick="toggleCatalog(false)">‚úñ</span>
        <h2>CAT√ÅLOGO DE COCHES</h2>
        <div class="car-option" onclick="selectCar('B√°sico', 0, 0x3498db)">
            <h3>TURBO COMPACT</h3>
            <p>Precio: GRATIS</p>
        </div>
        <div class="car-option" onclick="selectCar('Sport', 1000, 0xe74c3c)">
            <h3>DRIFT MONSTER</h3>
            <p>Precio: 1000 üí∞</p>
        </div>
        <p id="shopMsg" style="color: #f1c40f;"></p>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- CONFIGURACI√ìN ---
        let coins = 0;
        let currentCarColor = 0x3498db;
        let stats = { accel: 0.007, max: 0.6, turn: 0.045 };
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Luces
        const sun = new THREE.DirectionalLight(0xffffff, 1.5);
        sun.position.set(100, 100, 50);
        sun.castShadow = true;
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        // --- PISTA CON CURVAS REALISTAS ---
        const curve = new THREE.CatmullRomCurve3([
            new THREE.Vector3(0, 0, 0),
            new THREE.Vector3(50, 0, 20),
            new THREE.Vector3(80, 0, 80),
            new THREE.Vector3(40, 0, 120),
            new THREE.Vector3(-40, 0, 100),
            new THREE.Vector3(-80, 0, 40),
            new THREE.Vector3(-20, 0, -20),
            new THREE.Vector3(0, 0, 0)
        ]);

        const trackGeo = new THREE.TubeGeometry(curve, 100, 8, 20, true);
        const trackMat = new THREE.MeshPhongMaterial({ color: 0x222222 });
        const track = new THREE.Mesh(trackGeo, trackMat);
        track.scale.set(1, 0.01, 1); // Aplastar el tubo para que sea una pista plana
        scene.add(track);

        // Suelo infinito
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(2000, 2000), new THREE.MeshPhongMaterial({ color: 0x2ecc71 }));
        ground.rotation.x = -Math.PI/2;
        ground.receiveShadow = true;
        scene.add(ground);

        // --- CREACI√ìN DE COCHE COOL ---
        function createCoolCar(color) {
            const car = new THREE.Group();
            // Chasis
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.5, 3), new THREE.MeshPhongMaterial({ color }));
            body.position.y = 0.4;
            body.castShadow = true;
            car.add(body);
            // Aler√≥n
            const wing = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.1, 0.4), new THREE.MeshPhongMaterial({ color: 0x111111 }));
            wing.position.set(0, 0.8, -1.3);
            car.add(wing);
            // Cabina
            const glass = new THREE.Mesh(new THREE.BoxGeometry(1, 0.4, 1.2), new THREE.MeshPhongMaterial({ color: 0x222222, transparent: true, opacity: 0.7 }));
            glass.position.set(0, 0.8, 0);
            car.add(glass);
            return car;
        }

        const playerCar = createCoolCar(0x3498db);
        scene.add(playerCar);

        const aiCar = createCoolCar(0xe74c3c);
        scene.add(aiCar);

        // --- SISTEMA DE HUMO ---
        const particles = [];
        function createSmoke(pos) {
            const p = new THREE.Mesh(new THREE.SphereGeometry(0.2, 4, 4), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.6 }));
            p.position.copy(pos);
            scene.add(p);
            particles.push({ mesh: p, life: 1.0 });
        }

        // --- L√ìGICA ---
        const keys = {};
        window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
        window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

        let speed = 0, rotation = 0, drift = 0, aiProgress = 0;

        // Funciones de Tienda
        window.toggleCatalog = (show) => {
            document.getElementById('catalog').style.display = show ? 'block' : 'none';
        };

        window.selectCar = (name, price, color) => {
            if (coins >= price) {
                if(price > 0) coins -= price;
                currentCarColor = color;
                playerCar.children[0].material.color.setHex(color);
                if(name === 'Sport') stats = { accel: 0.012, max: 0.9, turn: 0.06 };
                document.getElementById('shopMsg').innerText = "¬°Coche seleccionado!";
                document.getElementById('coinCount').innerText = Math.floor(coins);
            } else {
                document.getElementById('shopMsg').innerText = "¬°Necesitas m√°s monedas!";
            }
        };

        function update() {
            // Movimiento Jugador
            if (keys['w'] || keys['arrowup']) speed += stats.accel;
            if (keys['s'] || keys['arrowdown']) speed -= stats.accel;
            speed *= 0.98;

            const isTurning = keys['a'] || keys['d'] || keys['arrowleft'] || keys['arrowright'];
            if (Math.abs(speed) > 0.1) {
                const turnDir = (keys['a'] || keys['arrowleft']) ? 1 : (keys['d'] || keys['arrowright']) ? -1 : 0;
                rotation += turnDir * stats.turn * (speed / stats.max);
                drift = THREE.MathUtils.lerp(drift, turnDir * 0.6, 0.1);

                if (turnDir !== 0 && Math.abs(speed) > 0.3) {
                    coins += 1;
                    document.getElementById('coinCount').innerText = Math.floor(coins);
                    createSmoke(playerCar.position.clone().add(new THREE.Vector3(0,0,-1).applyQuaternion(playerCar.quaternion)));
                }
            } else {
                drift = THREE.MathUtils.lerp(drift, 0, 0.1);
            }

            playerCar.rotation.y = rotation;
            playerCar.children[0].rotation.y = drift;
            playerCar.position.x += Math.sin(rotation + drift * 0.5) * speed;
            playerCar.position.z += Math.cos(rotation + drift * 0.5) * speed;

            // IA siguiendo la curva
            aiProgress += 0.0015;
            const aiPos = curve.getPointAt(aiProgress % 1);
            aiCar.position.copy(aiPos);
            const aiLook = curve.getPointAt((aiProgress + 0.01) % 1);
            aiCar.lookAt(aiLook);

            // Part√≠culas
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].life -= 0.03;
                particles[i].mesh.material.opacity = particles[i].life;
                particles[i].mesh.scale.multiplyScalar(1.05);
                if (particles[i].life <= 0) {
                    scene.remove(particles[i].mesh);
                    particles.splice(i, 1);
                }
            }

            // C√°mara
            const camOffset = new THREE.Vector3(0, 4, -10).applyQuaternion(playerCar.quaternion);
            camera.position.lerp(playerCar.position.clone().add(camOffset), 0.1);
            camera.lookAt(playerCar.position);
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }

        animate();
    </script>
</body>
</html>
