<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Neon Dash 3.2</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000;font-family:Arial, Helvetica, sans-serif;}
canvas{display:block;background:#000;}
#ui{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;z-index:10;}
.screen{display:none;flex-direction:column;align-items:center;gap:20px;color:#0ff;font-size:32px;text-shadow:0 0 15px #0ff;}
.screen.active{display:flex;}
button{padding:14px 32px;font-size:20px;border:none;border-radius:10px;background:#f06;color:white;cursor:pointer;box-shadow:0 0 20px #f06;}
button:hover{transform:scale(1.05);}
#progress{position:fixed;top:0;left:0;width:100%;height:14px;background:#111;z-index:15;}
#bar{height:100%;width:0%;background:linear-gradient(90deg,#60f,#0ff,#f06);}
</style>
</head>
<body>

<div id="progress"><div id="bar"></div></div>

<div id="ui">
  <div id="start" class="screen active">
    <div>âœ¨ NEON DASH 3.2 âœ¨</div>
    <button onclick="show('levels')">JUGAR</button>
    <button onclick="show('mapmaker')">MAP MAKER</button>
  </div>

  <div id="levels" class="screen">
    <div>Selecciona Nivel</div>
    <div id="levelButtons"></div>
  </div>

  <div id="over" class="screen">
    <div id="overText"></div>
    <button onclick="show('levels')">Volver</button>
  </div>

  <div id="mapmaker" class="screen">
    <div>Map Maker (Click para colocar bloques, spikes o UFOs)</div>
    <div style="margin:10px;">
      <button onclick="currentPlace='block'">Bloque</button>
      <button onclick="currentPlace='spike'">Spike</button>
      <button onclick="currentPlace='ufo'">UFO</button>
    </div>
    <button onclick="saveMap()">Guardar Mapa</button>
    <button onclick="show('start')">Volver</button>
  </div>
</div>

<canvas id="game"></canvas>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
addEventListener("resize",resize);
resize();

/* ===== UI ===== */
const screens={start:document.getElementById("start"),levels:document.getElementById("levels"),over:document.getElementById("over"),mapmaker:document.getElementById("mapmaker")};
function show(name){Object.values(screens).forEach(s=>s.classList.remove("active"));if(name)screens[name].classList.add("active");}

/* ===== GAME DATA ===== */
let state="menu";
let level=1;
let distance=0;
const levelLength=16000;

let player;
let spikes=[];
let blocks=[];
let ufos=[];

/* Niveles */
const levels={};
for(let i=1;i<=10;i++){levels[i]={speed:5+i*0.5,color:`hsl(${i*36},100%,50%)`};}

/* Genera botones de niveles */
const levelButtons=document.getElementById("levelButtons");
for(let i=1;i<=10;i++){const btn=document.createElement("button");btn.innerText=i;btn.onclick=()=>startLevel(i);levelButtons.appendChild(btn);}

/* ===== START LEVEL ===== */
function startLevel(lvl){
  level=lvl; distance=0;
  document.getElementById("bar").style.width="0%";
  show(null);

  player={x:canvas.width*0.25,y:canvas.height*0.7,size:30,dy:0,grounded:false,rot:0,jumps:0};
  spikes=[]; blocks=[]; ufos=[];

  let x=canvas.width;
  for(let i=0;i<120;i++){
    x+=200+Math.random()*120;
    if(Math.random()<0.6) spikes.push({x,y:canvas.height*0.75,h:40});
    if(Math.random()<0.4) blocks.push({x,y:canvas.height*0.75-60,w:80,h:20});
    if(Math.random()<0.05) ufos.push({x,y:canvas.height*0.75-100,w:50,h:20,used:false});
  }

  state="play";
  requestAnimationFrame(loop);
}

/* ===== LOOP ===== */
const GRAVITY=0.8;
const JUMP=-15;

function loop(){
  if(state!=="play") return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const floor=canvas.height*0.75;
  ctx.fillStyle="#111";
  ctx.fillRect(0,floor,canvas.width,canvas.height-floor);

  /* player */
  player.dy+=GRAVITY;
  player.y+=player.dy;
  player.rot+=0.1;
  if(player.y+player.size>=floor){player.y=floor-player.size;player.dy=0;player.grounded=true; player.jumps=0;} 
  else player.grounded=false;

  const speed=levels[level].speed;
  spikes.forEach(s=>s.x-=speed);
  blocks.forEach(b=>b.x-=speed);
  ufos.forEach(u=>u.x-=speed);
  distance+=speed;

  /* draw spikes */
  ctx.fillStyle=levels[level].color;
  ctx.shadowColor=levels[level].color; ctx.shadowBlur=10;
  spikes.forEach(s=>{
    ctx.beginPath(); ctx.moveTo(s.x,s.y); ctx.lineTo(s.x+25,s.y-s.h); ctx.lineTo(s.x+50,s.y); ctx.fill();
  });
  ctx.shadowBlur=0;

  /* draw blocks */
  blocks.forEach(b=>{ctx.fillStyle="#0ff";ctx.fillRect(b.x,b.y,b.w,b.h);ctx.strokeStyle="#fff";ctx.strokeRect(b.x,b.y,b.w,b.h);});

  /* draw ufos */
  ufos.forEach(u=>{ctx.fillStyle=u.used?"#555":"#f0f";ctx.fillRect(u.x,u.y,u.w,u.h);ctx.strokeStyle="#fff";ctx.strokeRect(u.x,u.y,u.w,u.h);});

  /* draw player */
  ctx.save(); ctx.translate(player.x+15,player.y+15); ctx.rotate(player.rot); ctx.fillStyle=levels[level].color; ctx.fillRect(-15,-15,30,30); ctx.restore();

  /* collision spikes (triÃ¡ngulo hitbox) */
  for(let s of spikes){
    // usar rectÃ¡ngulo mÃ¡s pequeÃ±o centrado en punta
    const spikeTopX = s.x+25, spikeTopY = s.y-s.h;
    if(player.x+player.size>spikeTopX-15 && player.x<spikeTopX+15 &&
       player.y+player.size>spikeTopY && player.y<spikeTopY+s.h){
      end(false); return;
    }
  }

  /* collision blocks */
  blocks.forEach(b=>{if(player.x+player.size>b.x && player.x<b.x+b.w && player.y+player.size>b.y && player.y<b.y+b.h){if(player.dy>0) player.y=b.y-player.size, player.dy=0, player.grounded=true, player.jumps=0;} });

  /* collision UFO */
  ufos.forEach(u=>{
    if(!u.used && player.x+player.size>u.x && player.x<u.x+u.w &&
       player.y+player.size>u.y && player.y<u.y+u.h){
      player.dy=JUMP*1.2; player.jumps++; u.used=true;
    }
  });

  document.getElementById("bar").style.width=Math.min(distance/levelLength*100,100)+"%";
  requestAnimationFrame(loop);
}

/* ===== INPUT ===== */
addEventListener("keydown",e=>{if(e.code==="Space"&&state==="play") jump();});
canvas.addEventListener("click",jump);
function jump(){if(player.grounded || player.jumps<2){player.dy=JUMP;player.jumps++;}}

/* ===== END ===== */
function end(win){state="menu";document.getElementById("overText").innerText=win?`ðŸŽ‰ Nivel ${level} completado`:`ðŸ’¥ Game Over (Nivel ${level})`;show("over");}

/* ===== MAP MAKER ===== */
let mapEditor=[]; let currentPlace="block";
stateMapRender();

canvas.addEventListener("mousedown",e=>{
  if(state!=="mapmaker") return;
  const rect={x:e.clientX,y:e.clientY,type:currentPlace};
  mapEditor.push(rect);
  renderMapEditor();
});

function renderMapEditor(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  mapEditor.forEach(obj=>{
    if(obj.type==="block"){ctx.fillStyle="#0ff";ctx.fillRect(obj.x,obj.y,80,20); ctx.strokeStyle="#fff";ctx.strokeRect(obj.x,obj.y,80,20);}
    if(obj.type==="spike"){ctx.fillStyle="#f0f";ctx.beginPath();ctx.moveTo(obj.x,obj.y);ctx.lineTo(obj.x+25,obj.y-40);ctx.lineTo(obj.x+50,obj.y);ctx.fill();}
    if(obj.type==="ufo"){ctx.fillStyle="#f0f";ctx.fillRect(obj.x,obj.y,50,20);ctx.strokeStyle="#fff";ctx.strokeRect(obj.x,obj.y,50,20);}
  });
}

function saveMap(){console.log("Mapa guardado:",mapEditor);alert("Mapa guardado en consola (ejemplo).");}

/* Render map maker continuamente */
function stateMapRender(){
  if(state==="mapmaker"){renderMapEditor(); requestAnimationFrame(stateMapRender);}
  else setTimeout(stateMapRender,1000);
}
</script>
</body>
</html>
