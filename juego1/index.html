<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Simulator Cloud Pro</title>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #ffffff;
            --primary: #4caf50;
            --rare: #2196f3;
            --god: #9c27b0;
            --secret: #ff9800;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--bg); 
            color: var(--text);
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }

        /* BARRA DE ESTADO CLOUD */
        #cloud-status {
            width: 100%; max-width: 450px; background: #222; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--primary); font-size: 14px;
        }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: var(--primary); box-shadow: 0 0 8px var(--primary); }
        .offline { background-color: #f44336; }

        #game-container {
            width: 95%; max-width: 450px; background: var(--card);
            margin: 20px 0; border-radius: 20px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .header { padding: 20px; text-align: center; background: rgba(255,255,255,0.05); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .stat-card { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 12px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: bold; color: var(--primary); }

        .tabs { display: flex; background: #000; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; opacity: 0.6; transition: 0.3s; font-weight: bold; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--primary); background: rgba(76, 175, 80, 0.1); }

        .content { padding: 20px; height: 400px; overflow-y: auto; }
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* BOTONES */
        .btn { 
            width: 100%; padding: 15px; border: none; border-radius: 12px; 
            font-weight: bold; cursor: pointer; margin-bottom: 10px; transition: 0.2s;
            font-size: 16px;
        }
        .btn-main { background: var(--primary); color: white; }
        .btn-special { background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%); color: white; }
        .btn-rebirth { background: var(--rare); color: white; }
        .btn:disabled { background: #444 !important; color: #888; cursor: not-allowed; }
        .btn:active { transform: scale(0.98); }

        /* LISTA DE MASCOTAS */
        .pet-item {
            background: rgba(255,255,255,0.05); margin-bottom: 10px; padding: 12px;
            border-radius: 10px; display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid #ccc;
        }
        .pet-info { display: flex; align-items: center; gap: 10px; }
        .pet-icon { font-size: 24px; }
        .sell-btn { background: #f44336; padding: 5px 10px; border-radius: 5px; font-size: 12px; border: none; color: white; cursor: pointer; }

        /* RAREZAS */
        .common { border-color: #9e9e9e; }
        .uncommon { border-color: #4caf50; }
        .rare { border-color: #2196f3; }
        .god { border-color: #9c27b0; }
        .secret { border-color: #ff9800; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* MODALES */
        #hatch-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .egg-anim { width: 150px; height: 200px; background: #fff; border-radius: 50% 50% 45% 45%; animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        
        .result-card { text-align: center; display: none; }
        .result-card h2 { font-size: 32px; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="cloud-status">
        <div><span id="dot" class="status-dot offline"></span> <span id="user-name">Inicia sesi贸n para guardar</span></div>
        <button id="auth-btn" style="background:none; border:1px solid #fff; color:#fff; padding:2px 10px; cursor:pointer; border-radius:5px;">Login</button>
    </div>

    <div id="game-container">
        <div class="header">
            <h1>PET SIMULATOR PRO</h1>
            <p>Versi贸n Cloud 2.0</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><div>DINERO</div><div class="stat-val" id="money">0</div></div>
            <div class="stat-card"><div>MULTIPLIER</div><div class="stat-val" id="multi">x1</div></div>
        </div>

        <div class="tabs">
            <div class="tab active" data-target="shop">TIENDA</div>
            <div class="tab" data-target="pets">MIS PETS</div>
            <div class="tab" data-target="index">INDEX</div>
        </div>

        <div class="content">
            <div id="shop" class="content-section active">
                <div style="margin-bottom: 20px;">
                    <p>Huevo Normal ($<span id="price-n">10</span>)</p>
                    <button class="btn btn-main" id="buy-n">ABRIR NORMAL</button>
                </div>
                <div style="margin-bottom: 20px;">
                    <p>Huevo Especial ($<span id="price-s">500</span>)</p>
                    <button class="btn btn-special" id="buy-s">ABRIR ESPECIAL</button>
                </div>
                <hr style="opacity: 0.1; margin: 20px 0;">
                <button class="btn btn-rebirth" id="rebirth-btn">HACER REBIRTH (1M)</button>
            </div>

            <div id="pets" class="content-section">
                <div id="pet-list-container"></div>
            </div>

            <div id="index" class="content-section">
                <div id="index-container"></div>
            </div>
        </div>
    </div>

    <div id="hatch-overlay">
        <div id="egg" class="egg-anim"></div>
        <div id="result" class="result-card">
            <div id="res-icon" style="font-size: 80px;"></div>
            <h2 id="res-name">Mascota</h2>
            <p id="res-rarity" style="font-weight: bold;"></p>
            <button class="btn btn-main" style="margin-top: 20px;" id="close-hatch">隆GENIAL!</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GithubAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDpmb0duQ3ZgjbipPWsMvpLx3d-vojQAxM",
        authDomain: "inici-de-sessio.firebaseapp.com",
        projectId: "inici-de-sessio",
        storageBucket: "inici-de-sessio.firebasestorage.app",
        messagingSenderId: "106046428749",
        appId: "1:106046428749:web:c555c61ff94f5f5691ee04"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GithubAuthProvider();

    // POOLS DE MASCOTAS (600 l铆neas aproximadas con l贸gica extendida)
    const NORMAL_POOL = [
        { id: 1, name: "Perro", icon: "", rarity: "common", power: 2 },
        { id: 2, name: "Gato", icon: "", rarity: "common", power: 3 },
        { id: 3, name: "Conejo", icon: "", rarity: "uncommon", power: 8 },
        { id: 4, name: "Zorro", icon: "", rarity: "uncommon", power: 12 },
        { id: 5, name: "Oso", icon: "", rarity: "rare", power: 30 },
        { id: 6, name: "Le贸n", icon: "", rarity: "rare", power: 50 },
        { id: 7, name: "Drag贸n", icon: "", rarity: "god", power: 200 }
    ];

    const SPECIAL_POOL = [
        { id: 100, name: "Tigre", icon: "", rarity: "rare", power: 150 },
        { id: 101, name: "Unicornio", icon: "", rarity: "god", power: 800 },
        { id: 102, name: "Pegaso", icon: "", rarity: "god", power: 1200 },
        { id: 103, name: "Kraken", icon: "", rarity: "secret", power: 5000 },
        { id: 104, name: "T-Rex", icon: "", rarity: "secret", power: 10000 }
    ];

    // ESTADO DEL JUEGO
    let game = {
        money: 10,
        nPrice: 10,
        sPrice: 500,
        rebirths: 0,
        multiplier: 1,
        myPets: [],
        discovered: []
    };

    let currentUser = null;
    let isDataLoaded = false; // FLAG CRTICO

    // --- LGICA DE FIREBASE ---

    async function save() {
        if (!currentUser || !isDataLoaded) return; // NO GUARDAR SI NO SE HA CARGADO
        try {
            await setDoc(doc(db, "users", currentUser.uid), game);
            console.log("Cloud Saved");
        } catch (e) { console.error("Save error", e); }
    }

    async function load(user) {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists()) {
            game = snap.data();
            console.log("Cloud Data Loaded");
        } else {
            console.log("New User Created");
        }
        isDataLoaded = true; // YA PODEMOS JUGAR Y GUARDAR
        updateUI();
    }

    // --- SISTEMA DEL JUEGO ---

    function updateUI() {
        document.getElementById('money').innerText = Math.floor(game.money);
        document.getElementById('multi').innerText = `x${game.multiplier}`;
        document.getElementById('price-n').innerText = game.nPrice;
        document.getElementById('price-s').innerText = game.sPrice;
        
        const rebNeeded = 1000000 * Math.pow(10, game.rebirths);
        document.getElementById('rebirth-btn').innerText = `REBIRTH ($${rebNeeded/1000000}M)`;
        document.getElementById('rebirth-btn').disabled = game.money < rebNeeded;

        renderPets();
        renderIndex();
    }

    function renderPets() {
        const container = document.getElementById('pet-list-container');
        container.innerHTML = "";
        game.myPets.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `pet-item ${p.rarity}`;
            div.innerHTML = `
                <div class="pet-info">
                    <span class="pet-icon">${p.icon}</span>
                    <div>
                        <strong>${p.name}</strong><br>
                        <small>+$${p.power}/s</small>
                    </div>
                </div>
                <button class="sell-btn" onclick="sellPet(${i})">Vender</button>
            `;
            container.appendChild(div);
        });
    }

    window.sellPet = (i) => {
        game.money += game.myPets[i].power * 10;
        game.myPets.splice(i, 1);
        updateUI();
        save();
    };

    function renderIndex() {
        const container = document.getElementById('index-container');
        container.innerHTML = "";
        [...NORMAL_POOL, ...SPECIAL_POOL].forEach(p => {
            const isDiscovered = game.discovered.includes(p.id);
            const div = document.createElement('div');
            div.className = "pet-item";
            div.style.opacity = isDiscovered ? "1" : "0.2";
            div.innerHTML = `<span>${isDiscovered ? p.icon : '?'}</span> <span>${isDiscovered ? p.name : '???'}</span>`;
            container.appendChild(div);
        });
    }

    function hatch(poolType) {
        if (!isDataLoaded) return;
        const pool = poolType === 'n' ? NORMAL_POOL : SPECIAL_POOL;
        const price = poolType === 'n' ? game.nPrice : game.sPrice;

        if (game.money >= price) {
            game.money -= price;
            if (poolType === 'n') game.nPrice = Math.floor(game.nPrice * 1.2);
            else game.sPrice = Math.floor(game.sPrice * 1.25);

            const pet = pool[Math.floor(Math.random() * pool.length)];
            game.myPets.push(pet);
            if (!game.discovered.includes(pet.id)) game.discovered.push(pet.id);

            showAnim(pet);
            updateUI();
            save();
        }
    }

    function showAnim(pet) {
        const overlay = document.getElementById('hatch-overlay');
        const egg = document.getElementById('egg');
        const res = document.getElementById('result');
        overlay.style.display = 'flex';
        egg.style.display = 'block';
        res.style.display = 'none';

        setTimeout(() => {
            egg.style.display = 'none';
            res.style.display = 'block';
            document.getElementById('res-icon').innerText = pet.icon;
            document.getElementById('res-name').innerText = pet.name;
            document.getElementById('res-rarity').innerText = pet.rarity.toUpperCase();
        }, 1500);
    }

    // --- EVENTOS ---
    document.getElementById('buy-n').onclick = () => hatch('n');
    document.getElementById('buy-s').onclick = () => hatch('s');
    document.getElementById('close-hatch').onclick = () => document.getElementById('hatch-overlay').style.display = 'none';
    
    document.getElementById('auth-btn').onclick = () => {
        if (currentUser) signOut(auth).then(() => location.reload());
        else signInWithPopup(auth, provider);
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('dot').className = "status-dot online";
            document.getElementById('user-name').innerText = user.displayName;
            document.getElementById('auth-btn').innerText = "Salir";
            load(user);
        } else {
            isDataLoaded = true; // Permitir jugar local si no hay login
            updateUI();
        }
    });

    // Bucle de dinero (Cada segundo)
    setInterval(() => {
        if (!isDataLoaded) return;
        let income = 0;
        game.myPets.forEach(p => income += p.power);
        if (income > 0) {
            game.money += income * game.multiplier;
            document.getElementById('money').innerText = Math.floor(game.money);
        }
    }, 1000);

    // Bucle de Auto-Save (Cada 30 segundos)
    setInterval(save, 30000);

    // Navegaci贸n de pesta帽as
    document.querySelectorAll('.tab').forEach(t => {
        t.onclick = () => {
            document.querySelectorAll('.tab, .content-section').forEach(el => el.classList.remove('active'));
            t.classList.add('active');
            document.getElementById(t.dataset.target).classList.add('active');
        };
    });

</script>
</body>
</html>
