<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pet Simulator - Versi√≥n Original Recuperada</title>
    <style>
        body { background: #121212; color: white; font-family: sans-serif; display: flex; justify-content: center; padding-top: 50px; }
        #game { width: 400px; background: #1e1e1e; padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .stat-card { background: #2a2a2a; padding: 10px; border-radius: 10px; }
        .stat-val { color: #4caf50; font-weight: bold; font-size: 24px; }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-normal { background: #4caf50; }
        .btn-special { background: #f5576c; }
        .btn:active { transform: scale(0.98); }

        #pet-list { margin-top: 20px; text-align: left; max-height: 250px; overflow-y: auto; background: #151515; border-radius: 10px; padding: 10px; }
        .pet-item { background: #333; margin: 5px 0; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #4caf50; }
        
        #auth-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        #status-dot { width: 12px; height: 12px; background: #ff4444; border-radius: 50%; }
    </style>
</head>
<body>

<div id="game">
    <div id="auth-section">
        <div style="display: flex; align-items: center; gap: 8px;">
            <div id="status-dot"></div>
            <span id="user-display" style="font-size: 12px; color: #888;">Desconectado</span>
        </div>
        <button id="auth-btn" style="background: #444; color: white; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer;">Entrar</button>
    </div>

    <h1>PET SIMULATOR PRO</h1>
    
    <div class="stats-grid">
        <div class="stat-card">DINERO<br><span class="stat-val">$<span id="money-txt">0</span></span></div>
        <div class="stat-card">MULTI<br><span class="stat-val" id="multi-txt">x1</span></div>
    </div>

    <div id="shop">
        <div style="margin-bottom: 15px;">
            <p style="font-size: 14px; color: #aaa;">Huevo Normal ($<span id="price-n">10</span>)</p>
            <button class="btn btn-normal" id="buy-n">ABRIR HUEVO</button>
        </div>
        <div>
            <p style="font-size: 14px; color: #aaa;">Huevo Especial ($<span id="price-s">500</span>)</p>
            <button class="btn btn-special" id="buy-s">ABRIR ESPECIAL</button>
        </div>
    </div>

    <div id="pet-list">
        </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GithubAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDpmb0duQ3ZgjbipPWsMvpLx3d-vojQAxM",
        authDomain: "inici-de-sessio.firebaseapp.com",
        projectId: "inici-de-sessio",
        storageBucket: "inici-de-sessio.firebasestorage.app",
        messagingSenderId: "106046428749",
        appId: "1:106046428749:web:c555c61ff94f5f5691ee04"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GithubAuthProvider();

    // ESTADO DEL JUEGO
    let state = {
        money: 10,
        nPrice: 10,
        sPrice: 500,
        multiplier: 1,
        myPets: []
    };

    let currentUser = null;
    let dataLoaded = false; // LLAVE MAESTRA: Si esto es falso, no se sobreescribe nada.

    // CARGAR DESDE LA NUBE
    async function loadData(user) {
        try {
            const snap = await getDoc(doc(db, "users", user.uid));
            if (snap.exists()) {
                state = snap.data();
                console.log("Datos cargados correctamente.");
            } else {
                console.log("Usuario nuevo, se crear√° progreso.");
                await saveData();
            }
            dataLoaded = true; // AHORA S√ç: Datos cargados, ya se puede jugar y guardar.
            updateUI();
        } catch (e) { console.error("Error al cargar:", e); }
    }

    // GUARDAR EN LA NUBE
    async function saveData() {
        if (currentUser && dataLoaded) {
            try {
                await setDoc(doc(db, "users", currentUser.uid), state);
                console.log("Progreso guardado.");
            } catch (e) { console.error("Error al guardar:", e); }
        }
    }

    function updateUI() {
        document.getElementById('money-txt').innerText = Math.floor(state.money);
        document.getElementById('multi-txt').innerText = "x" + state.multiplier;
        document.getElementById('price-n').innerText = state.nPrice;
        document.getElementById('price-s').innerText = state.sPrice;

        const list = document.getElementById('pet-list');
        list.innerHTML = state.myPets.length === 0 ? "<p style='color:#666; text-align:center;'>No tienes mascotas todav√≠a</p>" : "";
        
        state.myPets.forEach(p => {
            list.innerHTML += `<div class="pet-item"><span>${p.icon} ${p.name}</span> <span style="color:#4caf50;">+$${p.power}/s</span></div>`;
        });
    }

    // COMPRAR HUEVOS
    document.getElementById('buy-n').onclick = () => {
        if (!dataLoaded) return;
        if (state.money >= state.nPrice) {
            state.money -= state.nPrice;
            state.nPrice = Math.floor(state.nPrice * 1.2);
            state.myPets.push({name: "Pollito", icon: "üê•", power: 2});
            updateUI();
            saveData();
        }
    };

    document.getElementById('buy-s').onclick = () => {
        if (!dataLoaded) return;
        if (state.money >= state.sPrice) {
            state.money -= state.sPrice;
            state.sPrice = Math.floor(state.sPrice * 1.3);
            state.myPets.push({name: "Tigre", icon: "üêØ", power: 15});
            updateUI();
            saveData();
        }
    };

    // SISTEMA DE AUTH
    document.getElementById('auth-btn').onclick = () => {
        if (currentUser) signOut(auth).then(() => location.reload());
        else signInWithPopup(auth, provider);
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('status-dot').style.background = "#4caf50";
            document.getElementById('user-display').innerText = user.displayName.split(' ')[0];
            document.getElementById('auth-btn').innerText = "Salir";
            loadData(user);
        } else {
            dataLoaded = true; // Permitir jugar localmente si no hay login
            updateUI();
        }
    });

    // DINERO PASIVO (1 segundo)
    setInterval(() => {
        if (!dataLoaded) return;
        let income = 0;
        state.myPets.forEach(p => income += p.power);
        if (income > 0) {
            state.money += (income * state.multiplier);
            document.getElementById('money-txt').innerText = Math.floor(state.money);
        }
    }, 1000);

    // AUTO-GUARDADO (Cada 1 segundos)
    setInterval(saveData, 1);

</script>
</body>
</html>
