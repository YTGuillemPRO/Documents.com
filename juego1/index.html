<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Huevos, Pets y Rebirth Mejorados + Index (Firebase)</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { 
    font-family: Arial, sans-serif; 
    height: 100vh; 
    overflow: hidden; 
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    display: flex; 
    justify-content: center; 
    align-items: center; 
  }
  #game { 
    width: 390px; 
    background: rgba(255,255,255,0.95); 
    border-radius: 20px; 
    padding: 18px; 
    text-align: center; 
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
  }
  h1 { font-size: 22px; margin-bottom: 8px; color: #333; }
  .top-buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 6px;
  }
  .tab-btn {
    flex: 1;
    padding: 6px;
    font-size: 12px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background: #e0e0e0;
    font-weight: bold;
  }
  .tab-btn.active {
    background: #4caf50;
    color: #fff;
  }
  .stats { background: #f8f9fa; padding: 10px; border-radius: 15px; margin: 6px 0; }
  .money { font-size: 22px; font-weight: bold; color: #4CAF50; }
  .egg-price { font-size: 15px; color: #666; margin: 4px 0 6px; }
  .egg-selector {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-bottom: 6px;
  }
  .egg-type-btn {
    flex: 1;
    padding: 6px 6px;
    font-weight: bold;
    border-radius: 10px;
    border: 2px solid transparent;
    cursor: pointer;
    background-color: #ddd;
    user-select: none;
    transition: 0.3s;
    font-size: 11px;
  }
  .egg-type-btn.active {
    background-color: #4caf50;
    color: white;
    border-color: #4caf50;
  }
  button { 
    width: 100%; 
    padding: 12px; 
    font-size: 15px; 
    border: none; 
    border-radius: 12px; 
    cursor: pointer; 
    margin: 5px 0; 
    transition: all 0.3s; 
  }
  #buyEggBtn { 
    background: linear-gradient(45deg, #ff6b6b, #feca57); 
    color: white; 
    font-weight: bold;
  }
  #buyEggBtn:hover { transform: scale(1.03); }
  #rebirthBtn {
    background: #2196F3;
    color: white;
    font-weight: bold;
    font-size: 13px;
  }
  #rebirthBtn:disabled {
    background: #90caf9;
    cursor: not-allowed;
  }
  #rebirthInfo {
    font-size: 11px;
    color: #555;
    margin-top: 2px;
  }
  #openResult { 
    min-height: 32px; 
    font-size: 13px; 
    font-weight: bold; 
    margin: 6px 0; 
    padding: 6px; 
    border-radius: 10px; 
    background: #e3f2fd; 
    border: 2px solid #2196F3;
  }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  #petList { 
    max-height: 210px; 
    overflow-y: auto; 
    margin-top: 6px; 
    text-align: left;
  }
  .pet { 
    margin: 4px 0; 
    padding: 7px; 
    border-radius: 10px; 
    font-weight: bold;
    background: #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
  }
  .common { background: #e0e0e0; color: #555; }
  .uncommon { background: #c8e6c9; color: #2e7d32; }
  .rare { background: #bbdefb; color: #1565c0; }
  .god { background: #f3e5f5; color: #7b1fa2; }
  .secret { background: #fff3e0; color: #ef6c00; }
  .og { background: #ffe0f0; color: #c2185b; }

  .sellBtn {
    background: #ef5350;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 3px 6px;
    cursor: pointer;
    font-weight: bold;
    font-size: 11px;
    transition: background 0.3s;
  }

  #indexList {
    max-height: 230px;
    overflow-y: auto;
    text-align: left;
    margin-top: 8px;
    font-size: 12px;
  }
  .index-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 6px;
    border-radius: 8px;
    margin-bottom: 3px;
    background: #f5f5f5;
  }
  .index-row.owned {
    background: #dcedc8;
  }
  .index-name { font-weight: bold; }
  .index-meta { font-size: 11px; color: #555; }

  #hatchOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 5;
  }
  #hatchBox {
    background: #ffffff;
    border-radius: 20px;
    padding: 18px;
    width: 260px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    position: relative;
  }
  #hatchEgg {
    width: 110px;
    height: 145px;
    margin: 0 auto 8px;
    background: radial-gradient(circle at 30% 30%, #fff, #ffd54f);
    border-radius: 50% 50% 45% 45%;
    border: 4px solid #ffb300;
    position: relative;
    animation: eggIdle 1.2s infinite ease-in-out;
  }
  #hatchedPetIcon { font-size: 42px; display: none; animation: petPop 0.5s ease-out forwards; }
  #hatchedPetName { font-weight: bold; margin-top: 6px; font-size: 15px; }
  #hatchedPetInfo { font-size: 12px; margin-top: 2px; color: #555; }

  @keyframes eggIdle {
    0%,100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-4px) rotate(-3deg); }
    50% { transform: translateY(0) rotate(3deg); }
  }
  @keyframes eggShake {
    0% { transform: translateX(0) rotate(0deg); }
    20% { transform: translateX(-8px) rotate(-6deg); }
    40% { transform: translateX(8px) rotate(6deg); }
    100% { transform: translateX(0) rotate(0deg); }
  }
  @keyframes eggBreak {
    0% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(1.25); }
  }
  @keyframes petPop {
    0% { transform: scale(0.3); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }
</style>
</head>
<body>

  <div id="hatchOverlay">
    <div id="hatchBox">
      <div id="hatchEgg"></div>
      <div id="hatchedPetIcon"></div>
      <div id="hatchedPetName"></div>
      <div id="hatchedPetInfo"></div>
      <button id="closeHatchBtn">Cerrar</button>
    </div>
  </div>

  <div id="game">
    <h1>ü•ö HUEVOS & PETS üêæ</h1>
    <div class="top-buttons">
      <button id="tabPetsBtn" class="tab-btn active">Juego</button>
      <button id="tabIndexBtn" class="tab-btn">Index</button>
    </div>

    <div class="stats">
      <div class="money">üí∞ $<span id="money">10</span></div>
      <div class="egg-price">ü•ö Precio: $<span id="eggPrice">10</span></div>
      <div class="egg-selector">
        <div id="normalEgg" class="egg-type-btn active">Normal</div>
        <div id="specialEgg" class="egg-type-btn">Especial</div>
      </div>
      <div id="rebirthInfo">Rebirth 1: 1M ‚Ä¢ Rebirth 2: 5M ‚Ä¢ Rebirth 3: 15M</div>
    </div>

    <div id="tabPets" class="tab-content active">
      <button id="buyEggBtn">üõí ABRIR HUEVO</button>
      <button id="rebirthBtn" disabled>‚ö° REBIRTH</button>
      <div id="openResult"></div>
      <div id="petList"></div>
    </div>

    <div id="tabIndex" class="tab-content">
      <div id="indexList"></div>
    </div>
  </div>
  <script type="module">
  // IMPORTACI√ìN FIREBASE
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpmb0duQ3ZgjbipPWsMvpLx3d-vojQAxM",
    authDomain: "inici-de-sessio.firebaseapp.com",
    projectId: "inici-de-sessio",
    storageBucket: "inici-de-sessio.firebasestorage.app",
    messagingSenderId: "106046428749",
    appId: "1:106046428749:web:c555c61ff94f5f5691ee04",
    databaseURL: "https://inici-de-sessio-default-rtdb.firebaseio.com"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const userId = "usuario_global"; // ID fijo para persistencia
  const userRef = ref(db, 'users/' + userId);

  // DATA POOLS
  const normalPets = [
    {index: 0,  icon:'üê≠', name: 'Rat√≥n',       rarity: 'common',   earnings: 5},
    {index: 1,  icon:'üê∂', name: 'Perro',       rarity: 'common',   earnings: 8},
    {index: 2,  icon:'üê∞', name: 'Conejo',      rarity: 'common',   earnings: 10},
    {index: 3,  icon:'üê±', name: 'Gato',        rarity: 'uncommon', earnings: 18},
    {index: 4,  icon:'ü¶ä', name: 'Zorro',       rarity: 'uncommon', earnings: 25},
    {index: 5,  icon:'üêº', name: 'Panda',       rarity: 'uncommon', earnings: 35},
    {index: 6,  icon:'ü¶Å', name: 'Le√≥n',        rarity: 'rare',     earnings: 80},
    {index: 7,  icon:'ü¶Ö', name: '√Åguila',      rarity: 'rare',     earnings: 120},
    {index: 8,  icon:'üê≤', name: 'Drag√≥n',      rarity: 'god',      earnings: 250},
    {index: 9,  icon:'üïäÔ∏è', name: 'F√©nix',      rarity: 'god',      earnings: 350},
    {index:10, icon:'ü¶Ñ', name: 'Unicornio',   rarity: 'secret',   earnings: 800}
  ];

  const specialPets = [
    {index: 0,  icon:'üê≠', name: 'Rat√≥n Dorado',     rarity: 'common',   earnings: 40},
    {index: 1,  icon:'üê∂', name: 'Perro Pro',        rarity: 'common',   earnings: 55},
    {index: 2,  icon:'üê±', name: 'Gato Gamer',       rarity: 'common',   earnings: 70},
    {index: 3,  icon:'ü¶ä', name: 'Zorro √âpico',      rarity: 'uncommon', earnings: 120},
    {index: 4,  icon:'üê∫', name: 'Lobo Alfa',        rarity: 'uncommon', earnings: 150},
    {index: 5,  icon:'üêØ', name: 'Tigre',            rarity: 'uncommon', earnings: 180},
    {index: 6,  icon:'ü¶Å', name: 'Le√≥n Dorado',      rarity: 'rare',     earnings: 300},
    {index: 7,  icon:'üêâ', name: 'Drag√≥n √âlite',     rarity: 'rare',     earnings: 420},
    {index: 8,  icon:'ü¶Ö', name: 'F√©nix Real',       rarity: 'god',      earnings: 700},
    {index: 9,  icon:'üê≤', name: 'Drag√≥n Ancestral', rarity: 'god',      earnings: 900},
    {index:10, icon:'ü¶£', name: 'Mamut ',          rarity: 'secret',   earnings: 2000},
    {index:11, icon:'üê∏', name: 'Coquis',            rarity: 'secret',   earnings: 1500},
    {index:12, icon:'Rex', name: 'T‚ÄëRex OG',         rarity: 'og',       earnings: 3000}
  ];

  // VARIABLES DE ESTADO
  let money = 10;
  let normalEggPrice = 10;
  let specialEggPrice = 500;
  let ownedPets = [];
  let rebirthLevel = 0;
  let moneyMultiplier = 1;
  let usingSpecialEgg = false;
  const rebirthThresholds = [1000000, 5000000, 15000000];

  // FUNCIONES DE PERSISTENCIA
  function save() {
    set(userRef, { money, normalEggPrice, specialEggPrice, ownedPets, rebirthLevel, moneyMultiplier });
  }

  function load() {
    get(userRef).then(snap => {
      if(snap.exists()){
        const d = snap.val();
        money = d.money; normalEggPrice = d.normalEggPrice; specialEggPrice = d.specialEggPrice;
        ownedPets = d.ownedPets || []; rebirthLevel = d.rebirthLevel; moneyMultiplier = d.moneyMultiplier;
        updateUI();
      }
    });
  }

  // L√ìGICA CORE (Mantenida exactamente igual a tu original)
  function getRarityChances() {
    const base = usingSpecialEgg ? {common: 35, uncommon: 30, rare: 18, god: 10, secret: 6, og: 1} : {common: 55, uncommon: 25, rare: 12, god: 6, secret: 2, og: 0};
    if (rebirthLevel >= 1) { base.common = Math.max(0, base.common - 5); base.rare += 2; base.god += 2; base.secret += 1; }
    if (rebirthLevel >= 2) { base.common = Math.max(0, base.common - 5); base.uncommon += 2; base.rare += 2; base.god += 1; base.secret += 1; }
    if (rebirthLevel >= 3) { base.common = Math.max(0, base.common - 5); base.rare += 1; base.god += 1; base.secret += 1; base.og += 1; }
    return base;
  }

  function openEgg() {
    const price = usingSpecialEgg ? specialEggPrice : normalEggPrice;
    if (money < price) return;
    money -= price;
    if (usingSpecialEgg) specialEggPrice = Math.floor(specialEggPrice * 1.2);
    else normalEggPrice = Math.floor(normalEggPrice * 1.2);
    
    const chances = getRarityChances();
    let rand = Math.random() * 100, cum = 0, rarity = 'common';
    for (let r in chances) { cum += chances[r]; if (rand < cum) { rarity = r; break; } }
    
    const pool = usingSpecialEgg ? specialPets : normalPets;
    const candidates = pool.filter(p => p.rarity === rarity);
    const pet = candidates[Math.floor(Math.random() * candidates.length)];
    ownedPets.push({...pet});
    
    showHatch(pet);
    updateUI();
    save();
  }

  function showHatch(pet) {
    const ov = document.getElementById('hatchOverlay');
    document.getElementById('hatchedPetIcon').textContent = pet.icon;
    document.getElementById('hatchedPetName').textContent = pet.name;
    document.getElementById('hatchedPetInfo').textContent = `+$${pet.earnings}/s`;
    ov.style.display = 'flex';
    document.getElementById('hatchEgg').style.animation = 'eggShake 0.6s';
    setTimeout(() => { document.getElementById('hatchEgg').style.opacity = '0'; document.getElementById('hatchedPetIcon').style.display = 'block'; }, 1000);
  }

  window.sellPet = (i) => { money += ownedPets[i].earnings * 6; ownedPets.splice(i, 1); updateUI(); save(); };

  function updateUI() {
    document.getElementById('money').textContent = Math.floor(money);
    document.getElementById('eggPrice').textContent = usingSpecialEgg ? specialEggPrice : normalEggPrice;
    const list = document.getElementById('petList');
    list.innerHTML = '';
    ownedPets.forEach((p, i) => {
      const d = document.createElement('div');
      d.className = `pet ${p.rarity}`;
      d.innerHTML = `<span>${p.icon} ${p.name}</span><button class="sellBtn" onclick="sellPet(${i})">Vender</button>`;
      list.appendChild(d);
    });
    checkRebirth();
  }

  function checkRebirth() {
    const btn = document.getElementById('rebirthBtn');
    if (rebirthLevel >= 3) { btn.textContent = "MAX"; return; }
    btn.disabled = money < rebirthThresholds[rebirthLevel];
    btn.textContent = `‚ö° REBIRTH (${rebirthThresholds[rebirthLevel].toLocaleString()}$)`;
  }

  // LISTENERS
  document.getElementById('buyEggBtn').onclick = openEgg;
  document.getElementById('closeHatchBtn').onclick = () => { document.getElementById('hatchOverlay').style.display = 'none'; document.getElementById('hatchedPetIcon').style.display = 'none'; document.getElementById('hatchEgg').style.opacity = '1'; };
  document.getElementById('rebirthBtn').onclick = () => { money = 10; rebirthLevel++; moneyMultiplier *= 2; updateUI(); save(); };
  document.getElementById('normalEgg').onclick = () => { usingSpecialEgg = false; updateUI(); };
  document.getElementById('specialEgg').onclick = () => { usingSpecialEgg = true; updateUI(); };

  setInterval(() => {
    let income = ownedPets.reduce((s, p) => s + p.earnings, 0) * moneyMultiplier;
    if(income > 0) { money += income; updateUI(); }
  }, 1000);

  load();
  // --- SISTEMA DE INDEX (POKEDEX) ---
  // Esta funci√≥n genera la lista completa de pets disponibles para el √°lbum
  function updateIndex() {
    const list = document.getElementById('indexList');
    list.innerHTML = '';
    
    // Unimos ambos pools para mostrar todo el contenido del juego
    const allPets = [
      ...normalPets.map(p => ({...p, egg: 'Normal'})),
      ...specialPets.map(p => ({...p, egg: 'Especial'}))
    ];

    // Creamos un Set para b√∫squeda r√°pida de pets obtenidos
    const ownedSet = new Set(ownedPets.map(p => p.icon + p.name + p.rarity));

    allPets.forEach(pet => {
      const key = pet.icon + pet.name + pet.rarity;
      const isOwned = ownedSet.has(key);
      
      const row = document.createElement('div');
      row.className = 'index-row' + (isOwned ? ' owned' : '');
      
      // Estructura visual de cada fila del index
      row.innerHTML = `
        <div class="index-name">${pet.icon} [#${pet.index}] ${pet.name}</div>
        <div class="index-meta">
            ${pet.rarity.toUpperCase()} ‚Ä¢ ${pet.egg} ‚Ä¢ $${pet.earnings}/seg
        </div>
      `;
      list.appendChild(row);
    });
  }

  // --- CONTROL DE PESTA√ëAS (TABS) ---
  const tabPetsBtn = document.getElementById('tabPetsBtn');
  const tabIndexBtn = document.getElementById('tabIndexBtn');
  const tabPets = document.getElementById('tabPets');
  const tabIndex = document.getElementById('tabIndex');

  tabPetsBtn.addEventListener('click', () => {
    tabPetsBtn.classList.add('active');
    tabIndexBtn.classList.remove('active');
    tabPets.classList.add('active');
    tabIndex.classList.remove('active');
  });

  tabIndexBtn.addEventListener('click', () => {
    tabIndexBtn.classList.add('active');
    tabPetsBtn.classList.remove('active');
    tabIndex.classList.add('active');
    tabPets.classList.remove('active');
    updateIndex(); // Refrescar el index al abrir la pesta√±a
  });

  // --- SELECTORES DE HUEVOS ---
  document.getElementById('normalEgg').addEventListener('click', function() {
    usingSpecialEgg = false;
    this.classList.add('active');
    document.getElementById('specialEgg').classList.remove('active');
    document.getElementById('eggPrice').textContent = normalEggPrice;
  });

  document.getElementById('specialEgg').addEventListener('click', function() {
    usingSpecialEgg = true;
    this.classList.add('active');
    document.getElementById('normalEgg').classList.remove('active');
    document.getElementById('eggPrice').textContent = specialEggPrice;
  });

  // --- L√ìGICA DE REBIRTH AVANZADA ---
  window.doRebirth = function() {
    if (rebirthLevel >= rebirthThresholds.length) return;
    
    const needed = rebirthThresholds[rebirthLevel];
    if (money < needed) return;

    // Incrementar nivel y multiplicadores
    rebirthLevel += 1;
    moneyMultiplier *= 2; 
    
    // Resetear progreso local para el nuevo prestigio
    money = 10;
    normalEggPrice = 10;
    specialEggPrice = 500;

    // Feedback visual
    document.getElementById('openResult').innerHTML = 
      `‚ö° ¬°REBIRTH ${rebirthLevel}! Suerte mejorada & x${moneyMultiplier} DINERO`;
    
    updateUI();
    save(); // Guardar en Firebase el nuevo estado de Rebirth
    
    setTimeout(() => { 
        document.getElementById('openResult').innerHTML = ''; 
    }, 3000);
  };

  // --- BUCLE DE DINERO PASIVO ---
  // Se ejecuta cada 1 segundo (1000ms)
  setInterval(() => {
    const totalEarnings = ownedPets.reduce((sum, pet) => {
        return sum + pet.earnings;
    }, 0);

    const finalIncome = totalEarnings * moneyMultiplier;

    if (finalIncome > 0) {
      money += finalIncome;
      document.getElementById('money').textContent = Math.floor(money);
      checkRebirth();
    }
  }, 1000);

  // --- INICIALIZACI√ìN FINAL ---
  // Al cargar todo el script, llamamos a la base de datos
  console.log("Conectando a Firebase...");
  load(); // Esta funci√≥n de la Parte 2 rellena todas las variables anteriores

</script>
</body>
</html>
  </script>
</body>
</html>
