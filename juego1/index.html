<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pets and Money GOLD - Cloud Edition</title>
<style>
  /* --- ESTILOS COMPLETOS --- */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Arial, sans-serif; 
    height: 100vh; overflow: hidden; 
    background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
    display: flex; justify-content: center; align-items: center; flex-direction: column;
  }

  /* Auth Bar superior */
  #auth-bar {
    width: 400px; background: rgba(36, 41, 46, 0.95); color: white; padding: 12px;
    border-radius: 20px 20px 0 0; text-align: center; font-size: 13px;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  #btn-login { background: #2ea44f; color: white; border: none; padding: 7px 14px; border-radius: 6px; cursor: pointer; font-weight: bold; }
  #btn-logout { background: #cb2431; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

  #game { 
    width: 400px; background: rgba(255,255,255,0.98); 
    border-radius: 0 0 20px 20px; padding: 20px; 
    text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
    position: relative;
  }

  h1 { font-size: 24px; margin-bottom: 10px; color: #333; letter-spacing: -1px; }

  .top-buttons { display: flex; gap: 10px; margin-bottom: 12px; }
  .tab-btn { flex: 1; padding: 10px; font-size: 14px; border-radius: 12px; border: none; cursor: pointer; background: #eee; font-weight: bold; transition: 0.3s; }
  .tab-btn.active { background: #4caf50; color: #fff; box-shadow: 0 4px 10px rgba(76,175,80,0.3); }

  .stats { background: #f8f9fa; padding: 15px; border-radius: 18px; margin-bottom: 12px; border: 1px solid #e9ecef; }
  .money { font-size: 28px; font-weight: bold; color: #2e7d32; }
  .egg-price { font-size: 16px; color: #666; margin: 6px 0; font-weight: 500; }

  .egg-selector { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
  .egg-type-btn { flex: 1; padding: 10px; font-weight: bold; border-radius: 12px; border: 2px solid transparent; cursor: pointer; background: #ddd; transition: 0.3s; }
  .egg-type-btn.active { background: #4caf50; color: white; border-color: #2e7d32; }

  button { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 14px; cursor: pointer; margin: 6px 0; font-weight: bold; transition: 0.2s; }
  #buyEggBtn { background: linear-gradient(45deg, #ff6b6b, #feca57); color: white; box-shadow: 0 6px 20px rgba(255,107,107,0.4); text-transform: uppercase; }
  #buyEggBtn:hover { transform: translateY(-2px); }
  #buyEggBtn:active { transform: translateY(0); }
  
  #rebirthBtn { background: #2196F3; color: white; }
  #rebirthBtn:disabled { background: #b0bec5; cursor: not-allowed; }

  /* Pesta√±as */
  .tab-content { display: none; height: 320px; overflow: hidden; }
  .tab-content.active { display: block; }

  #petList, #indexList { height: 100%; overflow-y: auto; padding-right: 5px; margin-top: 10px; }

  /* Estilos de Mascotas */
  .pet, .index-row { 
    margin-bottom: 10px; padding: 12px; border-radius: 15px; 
    display: flex; justify-content: space-between; align-items: center; font-size: 13px;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  .common { background: #e0e0e0; color: #555; }
  .uncommon { background: #c8e6c9; color: #2e7d32; }
  .rare { background: #bbdefb; color: #1565c0; }
  .god { background: #f3e5f5; color: #7b1fa2; border: 1px solid #ce93d8; }
  .secret { background: #fff3e0; color: #ef6c00; border: 1px solid #ffcc80; animation: glow 2s infinite; }
  .og { background: #ffe0f0; color: #c2185b; border: 2px solid #f06292; }

  @keyframes glow { 0% { box-shadow: 0 0 5px #ffcc80; } 50% { box-shadow: 0 0 15px #ff9800; } 100% { box-shadow: 0 0 5px #ffcc80; } }

  .sellBtn { background: #ff5252; color: white; padding: 6px 12px; border-radius: 10px; font-size: 11px; width: auto; margin: 0; }

  /* Index */
  .index-row.owned { background: #dcedc8; border: 1px solid #8bc34a; }
  .index-meta { font-size: 10px; color: #777; }

  /* Overlay de Apertura */
  #hatchOverlay { 
    position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
    display: none; align-items: center; justify-content: center; z-index: 1000; 
  }
  #hatchBox { background: white; padding: 35px; border-radius: 30px; width: 320px; text-align: center; }
  #hatchEgg { 
    width: 130px; height: 170px; background: radial-gradient(circle at 30% 30%, #fff, #ffd54f); 
    border-radius: 50% 50% 45% 45%; border: 6px solid #ffb300; margin: 0 auto; 
    animation: eggJump 0.8s infinite ease-in-out;
  }
  @keyframes eggJump { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-15px) rotate(5deg); } }
  .hidden { display: none !important; }
</style>
</head>
<body>

  <div id="auth-bar">
    <div id="user-logged-out">
      <span>Offline (Datos Locales)</span>
      <button id="btn-login">Login con GitHub</button>
    </div>
    <div id="user-logged-in" class="hidden">
      <span id="welcome-msg"></span>
      <button id="btn-logout">Cerrar Sesi√≥n</button>
    </div>
  </div>

  <div id="game">
    <h1>ü•ö PET SIMULATOR üêæ</h1>

    <div class="top-buttons">
      <button id="tabPetsBtn" class="tab-btn active">JUEGO</button>
      <button id="tabIndexBtn" class="tab-btn">INDEX</button>
    </div>

    <div class="stats">
      <div class="money">üí∞ $<span id="moneyDisplay">10</span></div>
      <div class="egg-price">ü•ö Precio: $<span id="eggPriceDisplay">10</span></div>
      <div class="egg-selector">
        <div id="normalEggBtn" class="egg-type-btn active">Normal</div>
        <div id="specialEggBtn" class="egg-type-btn">Especial</div>
      </div>
      <div id="rebirthInfo" style="font-size:11px; color:#666; margin-top:5px;">
        Rebirth 0 | Multiplicador x1
      </div>
    </div>

    <div id="tabPets" class="tab-content active">
      <button id="buyEggBtn">üõí ABRIR HUEVO</button>
      <button id="rebirthBtn" disabled>‚ö° REBIRTH</button>
      <div id="petList">
        <p style="color:#999; margin-top:20px;">Abre un huevo para empezar...</p>
      </div>
    </div>

    <div id="tabIndex" class="tab-content">
      <div id="indexList"></div>
    </div>
  </div>

  <div id="hatchOverlay">
    <div id="hatchBox">
      <div id="hatchEgg"></div>
      <div id="hatchResult" class="hidden">
        <div id="hatchIcon" style="font-size: 70px; margin-bottom:10px;"></div>
        <h2 id="hatchName"></h2>
        <p id="hatchRarity" style="letter-spacing:2px; font-weight:bold; margin:10px 0;"></p>
        <p id="hatchEarning" style="color:#2e7d32; font-weight:bold;"></p>
        <button id="closeHatchBtn" style="background:#4caf50; color:white; margin-top:20px;">CONTINUAR</button>
      </div>
    </div>
  </div>

<script type="module">
  // --- IMPORTACIONES FIREBASE ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithPopup, GithubAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpmb0duQ3ZgjbipPWsMvpLx3d-vojQAxM",
    authDomain: "inici-de-sessio.firebaseapp.com",
    projectId: "inici-de-sessio",
    storageBucket: "inici-de-sessio.firebasestorage.app",
    messagingSenderId: "106046428749",
    appId: "1:106046428749:web:c555c61ff94f5f5691ee04"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GithubAuthProvider();

  // --- CONFIGURACI√ìN DE MASCOTAS ---
  const NORMAL_PETS = [
    {id: 0,  icon:'üê≠', name: 'Rat√≥n',      rarity: 'common',   earnings: 5},
    {id: 1,  icon:'üê∂', name: 'Perro',      rarity: 'common',   earnings: 8},
    {id: 2,  icon:'üê∞', name: 'Conejo',     rarity: 'common',   earnings: 10},
    {id: 3,  icon:'üê±', name: 'Gato',       rarity: 'uncommon', earnings: 18},
    {id: 4,  icon:'ü¶ä', name: 'Zorro',      rarity: 'uncommon', earnings: 25},
    {id: 5,  icon:'üêº', name: 'Panda',      rarity: 'uncommon', earnings: 35},
    {id: 6,  icon:'ü¶Å', name: 'Le√≥n',       rarity: 'rare',     earnings: 80},
    {id: 7,  icon:'ü¶Ö', name: '√Åguila',     rarity: 'rare',     earnings: 120},
    {id: 8,  icon:'üê≤', name: 'Drag√≥n',     rarity: 'god',      earnings: 250},
    {id: 9,  icon:'üïäÔ∏è', name: 'F√©nix',      rarity: 'god',      earnings: 350},
    {id:10,  icon:'ü¶Ñ', name: 'Unicornio',  rarity: 'secret',   earnings: 800}
  ];

  const SPECIAL_PETS = [
    {id: 100, icon:'üê≠', name: 'Rat√≥n Dorado',     rarity: 'common',   earnings: 40},
    {id: 101, icon:'üê∂', name: 'Perro Pro',        rarity: 'common',   earnings: 55},
    {id: 102, icon:'üê±', name: 'Gato Gamer',       rarity: 'common',   earnings: 70},
    {id: 103, icon:'ü¶ä', name: 'Zorro √âpico',      rarity: 'uncommon', earnings: 120},
    {id: 104, icon:'üê∫', name: 'Lobo Alfa',        rarity: 'uncommon', earnings: 150},
    {id: 105, icon:'üêØ', name: 'Tigre',            rarity: 'uncommon', earnings: 180},
    {id: 106, icon:'ü¶Å', name: 'Le√≥n Dorado',      rarity: 'rare',     earnings: 300},
    {id: 107, icon:'üêâ', name: 'Drag√≥n √âlite',     rarity: 'rare',     earnings: 420},
    {id: 108, icon:'ü¶Ö', name: 'F√©nix Real',       rarity: 'god',      earnings: 700},
    {id: 109, icon:'üê≤', name: 'Drag√≥n Ancestral', rarity: 'god',      earnings: 900},
    {id: 110, icon:'ü¶£', name: 'Mamut OG',         rarity: 'secret',   earnings: 2000},
    {id: 111, icon:'üê∏', name: 'Coquis',           rarity: 'secret',   earnings: 1500},
    {id: 112, icon:'Rex', icon:'ü¶ñ', name: 'T‚ÄëRex OG', rarity: 'og',   earnings: 3000}
  ];

  const REBIRTH_THRESHOLDS = [1000000, 5000000, 15000000, 50000000, 100000000];

  // --- ESTADO DEL JUEGO ---
  let state = {
    money: 10,
    normalPrice: 10,
    specialPrice: 500,
    rebirthLevel: 0,
    multiplier: 1,
    ownedPets: [],
    unlockedIds: []
  };

  let currentUser = null;
  let isSpecialMode = false;

  // --- PERSISTENCIA (FIRESTORE) ---
  async function saveToCloud() {
    if (!currentUser) return;
    try {
      await setDoc(doc(db, "users", currentUser.uid), state);
    } catch (e) { console.error("Error guardando:", e); }
  }

  async function loadFromCloud(user) {
    const docSnap = await getDoc(doc(db, "users", user.uid));
    if (docSnap.exists()) {
      state = { ...state, ...docSnap.data() };
      updateUI();
    }
  }

  // --- LOGICA DEL JUEGO ---
  function updateUI() {
    document.getElementById('moneyDisplay').innerText = Math.floor(state.money);
    document.getElementById('eggPriceDisplay').innerText = isSpecialMode ? state.specialPrice : state.normalPrice;
    
    // Rebirth Info
    document.getElementById('rebirthInfo').innerText = `Rebirth ${state.rebirthLevel} | Multiplicador x${state.multiplier}`;
    
    const rBtn = document.getElementById('rebirthBtn');
    if (state.rebirthLevel >= REBIRTH_THRESHOLDS.length) {
      rBtn.innerText = "MAX REBIRTH";
      rBtn.disabled = true;
    } else {
      const needed = REBIRTH_THRESHOLDS[state.rebirthLevel];
      rBtn.innerText = `‚ö° REBIRTH ($${(needed/1000000).toFixed(1)}M)`;
      rBtn.disabled = state.money < needed;
    }

    renderPetList();
    renderIndex();
  }

  function renderPetList() {
    const container = document.getElementById('petList');
    if (state.ownedPets.length === 0) {
      container.innerHTML = '<p style="color:#999; margin-top:20px;">Abre un huevo para empezar...</p>';
      return;
    }

    const income = state.ownedPets.reduce((s, p) => s + p.earnings, 0) * state.multiplier;
    container.innerHTML = `<div style="font-weight:bold; color:#2e7d32; margin-bottom:10px;">Ingresos: $${income}/seg</div>`;

    state.ownedPets.forEach((pet, index) => {
      const div = document.createElement('div');
      div.className = `pet ${pet.rarity}`;
      div.innerHTML = `
        <span>${pet.icon} ${pet.name} (+$${pet.earnings}/s)</span>
        <button class="sellBtn" onclick="window.sellPet(${index})">Vender</button>
      `;
      container.appendChild(div);
    });
  }

  window.sellPet = (index) => {
    const pet = state.ownedPets[index];
    state.money += pet.earnings * 10;
    state.ownedPets.splice(index, 1);
    updateUI();
    saveToCloud();
  };

  function renderIndex() {
    const container = document.getElementById('indexList');
    container.innerHTML = "";
    const all = [...NORMAL_PETS, ...SPECIAL_PETS];
    
    all.forEach(p => {
      const isOwned = state.unlockedIds.includes(p.id);
      const div = document.createElement('div');
      div.className = `index-row ${isOwned ? 'owned' : 'common'}`;
      div.style.opacity = isOwned ? "1" : "0.3";
      div.innerHTML = `
        <div>
          <strong>${isOwned ? p.icon : '‚ùì'} ${p.name}</strong><br>
          <span class="index-meta">${p.rarity.toUpperCase()} ‚Ä¢ $${p.earnings}/s</span>
        </div>
        <div style="font-size:10px;">${isOwned ? 'COLECCIONADO' : 'BLOQUEADO'}</div>
      `;
      container.appendChild(div);
    });
  }

  function getRandomPet() {
    const pool = isSpecialMode ? SPECIAL_PETS : NORMAL_PETS;
    
    // Probabilidades basadas en Rebirth
    const chances = isSpecialMode 
      ? { common: 35, uncommon: 30, rare: 18, god: 10, secret: 6, og: 1 }
      : { common: 55, uncommon: 25, rare: 12, god: 6, secret: 2, og: 0 };

    // Ajuste por Rebirth (mejora suerte)
    if (state.rebirthLevel > 0) {
      chances.common -= (state.rebirthLevel * 5);
      chances.rare += (state.rebirthLevel * 2);
      chances.god += (state.rebirthLevel * 2);
    }

    const rand = Math.random() * 100;
    let cum = 0;
    let selectedRarity = 'common';

    for (let r in chances) {
      cum += chances[r];
      if (rand < cum) { selectedRarity = r; break; }
    }

    const candidates = pool.filter(p => p.rarity === selectedRarity);
    return candidates.length > 0 ? candidates[Math.floor(Math.random() * candidates.length)] : pool[0];
  }

  function buyEgg() {
    const price = isSpecialMode ? state.specialPrice : state.normalPrice;
    if (state.money < price) return;

    state.money -= price;
    if (isSpecialMode) state.specialPrice = Math.floor(state.specialPrice * 1.25);
    else state.normalPrice = Math.floor(state.normalPrice * 1.15);

    const pet = getRandomPet();
    state.ownedPets.push({...pet});
    if (!state.unlockedIds.includes(pet.id)) state.unlockedIds.push(pet.id);

    showAnimation(pet);
    updateUI();
    saveToCloud();
  }

  function showAnimation(pet) {
    const overlay = document.getElementById('hatchOverlay');
    const res = document.getElementById('hatchResult');
    const egg = document.getElementById('hatchEgg');

    overlay.style.display = 'flex';
    egg.classList.remove('hidden');
    res.classList.add('hidden');

    setTimeout(() => {
      egg.classList.add('hidden');
      res.classList.remove('hidden');
      document.getElementById('hatchIcon').innerText = pet.icon;
      document.getElementById('hatchName').innerText = pet.name;
      document.getElementById('hatchRarity').innerText = pet.rarity.toUpperCase();
      document.getElementById('hatchEarning').innerText = `+$${pet.earnings}/seg`;
    }, 1500);
  }

  // --- HANDLERS EVENTOS ---
  document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
  document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => location.reload());

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('user-logged-out').classList.add('hidden');
      document.getElementById('user-logged-in').classList.remove('hidden');
      document.getElementById('welcome-msg').innerText = "Hola, " + user.displayName.split(' ')[0];
      loadFromCloud(user);
    }
  });

  document.getElementById('buyEggBtn').onclick = buyEgg;
  document.getElementById('closeHatchBtn').onclick = () => document.getElementById('hatchOverlay').style.display = 'none';
  
  document.getElementById('normalEggBtn').onclick = function() {
    isSpecialMode = false;
    this.classList.add('active');
    document.getElementById('specialEggBtn').classList.remove('active');
    updateUI();
  };

  document.getElementById('specialEggBtn').onclick = function() {
    isSpecialMode = true;
    this.classList.add('active');
    document.getElementById('normalEggBtn').classList.remove('active');
    updateUI();
  };

  document.getElementById('rebirthBtn').onclick = () => {
    const needed = REBIRTH_THRESHOLDS[state.rebirthLevel];
    if (state.money >= needed) {
      state.money = 10;
      state.normalPrice = 10;
      state.specialPrice = 500;
      state.rebirthLevel++;
      state.multiplier *= 2;
      state.ownedPets = []; // El Rebirth suele resetear mascotas seg√∫n el dise√±o
      updateUI();
      saveToCloud();
      alert("¬°REBIRTH REALIZADO! Tu suerte y dinero ahora son x" + state.multiplier);
    }
  };

  // Tabs
  document.getElementById('tabPetsBtn').onclick = () => {
    document.getElementById('tabPets').classList.add('active');
    document.getElementById('tabIndex').classList.remove('active');
    document.getElementById('tabPetsBtn').classList.add('active');
    document.getElementById('tabIndexBtn').classList.remove('active');
  };
  document.getElementById('tabIndexBtn').onclick = () => {
    document.getElementById('tabIndex').classList.add('active');
    document.getElementById('tabPets').classList.remove('active');
    document.getElementById('tabIndexBtn').classList.add('active');
    document.getElementById('tabPetsBtn').classList.remove('active');
    renderIndex();
  };

  // Bucle de dinero
  setInterval(() => {
    const income = state.ownedPets.reduce((acc, p) => acc + p.earnings, 0) * state.multiplier;
    if (income > 0) {
      state.money += income;
      document.getElementById('moneyDisplay').innerText = Math.floor(state.money);
      // Solo actualizamos el bot√≥n de Rebirth para no recargar todo el DOM cada segundo
      const needed = REBIRTH_THRESHOLDS[state.rebirthLevel];
      document.getElementById('rebirthBtn').disabled = state.money < needed;
    }
  }, 1000);

  updateUI();
</script>
</body>
</html>
