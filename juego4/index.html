<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Nova League 3D - Pro Edition ‚öΩ</title>
<style>
body{margin:0;overflow:hidden;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#000;}
#menu, #overlay{
  position:absolute;top:0;left:0;right:0;bottom:0;
  background:linear-gradient(180deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  color:white;text-align:center;transition:opacity 0.5s;z-index:100;
}
#ui-container{
    position:absolute;top:20px;width:100%;display:flex;justify-content:center;
    gap:50px;pointer-events:none;z-index:10;
}
.hud-box{
    background:rgba(0,0,0,0.6);padding:10px 25px;border-radius:15px;
    border:2px solid #00d4ff;color:white;font-size:1.8em;font-weight:bold;
}
#goalMsg{
    position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);
    color:#fff;font-size:6em;font-weight:bold;text-shadow:0 0 30px #000;
    z-index:20;display:none;pointer-events:none;
}
.btn{
  background:linear-gradient(45deg,#ff6b6b,#ffd93d);
  border:none;padding:15px 40px;font-size:1.2em;border-radius:50px;
  cursor:pointer;color:white;font-weight:bold;text-transform:uppercase;
  transition:all 0.3s;margin:10px;
}
.btn:hover{transform:scale(1.1);box-shadow:0 0 20px rgba(255,217,61,0.6);}
h1{font-size:4em;margin:0;text-shadow:0 0 20px #00d4ff;}
#game{display:none;}
</style>
</head>
<body>

<div id="menu">
  <h1>‚öΩ NOVA LEAGUE</h1>
  <p>2 PARTES DE 3 MINUTOS</p>
  <h2>SELECCIONA DIFICULTAD</h2>
  <button class="btn" onclick="startGame(0.08)">F√ÅCIL</button>
  <button class="btn" onclick="startGame(0.14)">NORMAL</button>
  <button class="btn" onclick="startGame(0.20)">DIF√çCIL</button>
  <p>WASD: Mover | E: Disparar | Q: Pase Largo | F: Robar</p>
</div>

<div id="overlay" style="display:none;">
    <h1 id="overlayTitle">FIN DE LA PARTE</h1>
    <button class="btn" id="overlayBtn" onclick="nextHalf()">CONTINUAR</button>
</div>

<div id="ui-container">
    <div class="hud-box" id="score">üî¥ 0 - 0 üîµ</div>
    <div class="hud-box" id="timer">03:00</div>
</div>
<div id="goalMsg">¬°GOL!</div>
<div id="game"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<script>
let gameActive = false;
let timeLeft = 180; // 3 minutos
let currentHalf = 1;
let redScore = 0, blueScore = 0;
let clockInterval;
let difficultyLevel = 0.1;

const scoreEl = document.getElementById('score');
const timerEl = document.getElementById('timer');
const goalMsg = document.getElementById('goalMsg');

function startGame(diff){
    difficultyLevel = diff;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    initGame();
    startClock();
}

function startClock(){
    gameActive = true;
    clockInterval = setInterval(() => {
        if(!gameActive) return;
        timeLeft--;
        let mins = Math.floor(timeLeft/60);
        let secs = timeLeft % 60;
        timerEl.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
        
        if(timeLeft <= 0) endHalf();
    }, 1000);
}

function endHalf(){
    gameActive = false;
    clearInterval(clockInterval);
    const overlay = document.getElementById('overlay');
    const title = document.getElementById('overlayTitle');
    const btn = document.getElementById('overlayBtn');
    
    overlay.style.display = 'flex';
    if(currentHalf === 1){
        title.textContent = "DESCANSO";
        btn.textContent = "EMPEZAR 2¬™ PARTE";
    } else {
        title.textContent = redScore > blueScore ? "¬°VICTORIA ROJA! üî¥" : (blueScore > redScore ? "¬°VICTORIA AZUL! üîµ" : "EMPATE");
        btn.textContent = "REINICIAR";
        btn.onclick = () => location.reload();
    }
}

function nextHalf(){
    currentHalf = 2;
    timeLeft = 180;
    document.getElementById('overlay').style.display = 'none';
    resetPositions();
    startClock();
}

function initGame(){
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x1a1a2e);
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({ antialias:true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.getElementById('game').appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0xffffff,0.8));
  const light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(10,50,10);
  scene.add(light);

  // CAMPO
  const W = 140, H = 80;
  const field = new THREE.Mesh(new THREE.PlaneGeometry(W,H), new THREE.MeshLambertMaterial({color:0x2d8a2d}));
  field.rotation.x = -Math.PI/2;
  scene.add(field);

  // PORTER√çAS
  function createGoal(x, color) {
    const g = new THREE.Group();
    const mat = new THREE.MeshLambertMaterial({color: 0xffffff});
    const p1 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 6, 0.5), mat);
    const p2 = p1.clone();
    const top = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 16), mat);
    p1.position.set(x, 3, -8); p2.position.set(x, 3, 8); top.position.set(x, 6, 0);
    g.add(p1, p2, top); scene.add(g);
  }
  createGoal(-W/2, 0xff0000); createGoal(W/2, 0x0000ff);

  // JUGADORES CON PELO COMPLETO
  function createPlayer(color, x, z) {
    const g = new THREE.Group();
    // Cuerpo
    const body = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.6,1.8,8), new THREE.MeshLambertMaterial({color}));
    body.position.y = 1.6;
    // Cabeza
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.45,16,16), new THREE.MeshLambertMaterial({color:0xffdbac}));
    head.position.y = 2.7;
    // PELO (Ahora cubre toda la cabeza)
    const hairGeo = new THREE.SphereGeometry(0.48, 16, 16, 0, Math.PI * 2, 0, Math.PI * 0.6); 
    const hair = new THREE.Mesh(hairGeo, new THREE.MeshLambertMaterial({color:0x221100}));
    hair.position.y = 2.8;
    hair.rotation.x = Math.PI; // Invertir para que cubra arriba y laterales
    
    g.add(body, head, hair);
    g.position.set(x, 0, z);
    scene.add(g);
    g.userData = { color, homeX:x, homeZ:z, hasBall:false, speed: difficultyLevel };
    return g;
  }

  const redTeam = [], blueTeam = [];
  const positions = [[-60,0],[-45,15],[-45,-15],[-30,25],[-30,-25],[-15,10],[-15,-10],[5,20],[5,-20],[20,0],[0,0]];
  
  positions.forEach(pos => redTeam.push(createPlayer(0xff4444, pos[0], pos[1])));
  positions.forEach(pos => blueTeam.push(createPlayer(0x4444ff, -pos[0], pos[1])));

  const player = redTeam[10]; // El usuario controla este

  // BAL√ìN
  const ball = new THREE.Mesh(new THREE.SphereGeometry(0.6,16,16), new THREE.MeshLambertMaterial({color:0xffffff}));
  ball.position.y = 0.6;
  ball.userData = { vx:0, vz:0, holder:null };
  scene.add(ball);

  const keys = {};
  window.onkeydown = e => keys[e.key.toLowerCase()] = true;
  window.onkeyup = e => keys[e.key.toLowerCase()] = false;

  function resetPositions(){
    ball.position.set(0,0.6,0);
    ball.userData.vx = 0; ball.userData.vz = 0; ball.userData.holder = null;
    redTeam.forEach(p => { p.position.set(p.userData.homeX, 0, p.userData.homeZ); p.userData.hasBall = false; });
    blueTeam.forEach(p => { p.position.set(p.userData.homeX, 0, p.userData.homeZ); p.userData.hasBall = false; });
  }

  function goal(team){
    if(team === 'red') redScore++; else blueScore++;
    scoreEl.textContent = `üî¥ ${redScore} - ${blueScore} üîµ`;
    goalMsg.style.display = 'block';
    goalMsg.textContent = team === 'red' ? "¬°GOL ROJO!" : "¬°GOL AZUL!";
    gameActive = false;
    setTimeout(() => { goalMsg.style.display = 'none'; resetPositions(); gameActive = true; }, 2000);
  }

  function handleAI(p, team, teammates, rivals, targetGoalX){
    if(!gameActive) return;

    if(p.userData.hasBall){
        const distToGoal = Math.abs(targetGoalX - p.position.x);
        
        // IA DECIDE: ¬øCHUTAR O PASAR?
        if(distToGoal < 25){ // Cerca de porter√≠a -> CHUTA
            const dx = targetGoalX - p.position.x;
            const dz = 0 - p.position.z;
            const angle = Math.atan2(dx, dz);
            ball.userData.vx = Math.sin(angle) * 0.8;
            ball.userData.vz = Math.cos(angle) * 0.8;
            ball.userData.holder = null;
            p.userData.hasBall = false;
        } else {
            // Buscar pase a compa√±ero adelantado
            let bestPassTarget = null;
            teammates.forEach(mate => {
                if(mate !== p && ((team === 'red' && mate.position.x > p.position.x) || (team === 'blue' && mate.position.x < p.position.x))){
                    bestPassTarget = mate;
                }
            });

            if(bestPassTarget && Math.random() < 0.02){ // Probabilidad de pase
                const dx = bestPassTarget.position.x - p.position.x;
                const dz = bestPassTarget.position.z - p.position.z;
                const dist = Math.sqrt(dx*dx+dz*dz);
                ball.userData.vx = (dx/dist) * 0.6;
                ball.userData.vz = (dz/dist) * 0.6;
                ball.userData.holder = null;
                p.userData.hasBall = false;
            } else {
                // Avanzar con bal√≥n
                p.position.x += (targetGoalX > p.position.x ? 1 : -1) * p.userData.speed * 1.2;
                p.rotation.y = targetGoalX > p.position.x ? Math.PI/2 : -Math.PI/2;
            }
        }
    } else {
        // Si no tiene el bal√≥n, ir hacia √©l si est√° cerca o volver a posici√≥n
        const distBall = p.position.distanceTo(ball.position);
        if(distBall < 30 && !ball.userData.holder){
            const angle = Math.atan2(ball.position.x - p.position.x, ball.position.z - p.position.z);
            p.position.x += Math.sin(angle) * p.userData.speed;
            p.position.z += Math.cos(angle) * p.userData.speed;
            p.rotation.y = angle;
        } else {
            p.position.x += (p.userData.homeX - p.position.x) * 0.01;
            p.position.z += (p.userData.homeZ - p.position.z) * 0.01;
        }
    }
  }

  function animate() {
    requestAnimationFrame(animate);
    if(!gameActive) { renderer.render(scene, camera); return; }

    // Control Jugador
    if(keys['w']) { player.position.x += Math.sin(player.rotation.y)*0.3; player.position.z += Math.cos(player.rotation.y)*0.3; }
    if(keys['s']) { player.position.x -= Math.sin(player.rotation.y)*0.2; player.position.z -= Math.cos(player.rotation.y)*0.2; }
    if(keys['a']) player.rotation.y += 0.05;
    if(keys['d']) player.rotation.y -= 0.05;

    // Acci√≥n de disparo/pase
    if((keys['e'] || keys['q']) && player.userData.hasBall){
        const force = keys['e'] ? 0.9 : 0.5;
        ball.userData.vx = Math.sin(player.rotation.y) * force;
        ball.userData.vz = Math.cos(player.rotation.y) * force;
        ball.userData.holder = null;
        player.userData.hasBall = false;
    }

    // Robar bal√≥n (F)
    if(keys['f'] && ball.userData.holder && ball.userData.holder !== player){
        if(player.position.distanceTo(ball.position) < 3){
            ball.userData.holder.userData.hasBall = false;
            ball.userData.holder = player;
            player.userData.hasBall = true;
        }
    }

    // Actualizar IA
    redTeam.forEach(p => { if(p !== player) handleAI(p, 'red', redTeam, blueTeam, W/2); });
    blueTeam.forEach(p => handleAI(p, 'blue', blueTeam, redTeam, -W/2));

    // L√≥gica del Bal√≥n
    if(ball.userData.holder){
        const h = ball.userData.holder;
        ball.position.set(h.position.x + Math.sin(h.rotation.y)*1.2, 0.6, h.position.z + Math.cos(h.rotation.y)*1.2);
    } else {
        ball.position.x += ball.userData.vx;
        ball.position.z += ball.userData.vz;
        ball.userData.vx *= 0.98;
        ball.userData.vz *= 0.98;

        // Recogida de bal√≥n
        [...redTeam, ...blueTeam].forEach(p => {
            if(p.position.distanceTo(ball.position) < 1.5 && !ball.userData.holder){
                ball.userData.holder = p;
                p.userData.hasBall = true;
                ball.userData.vx = 0; ball.userData.vz = 0;
            }
        });
    }

    // L√≠mites y Goles
    if(ball.position.x > W/2) { if(Math.abs(ball.position.z) < 8) goal('red'); else ball.userData.vx *= -1; }
    if(ball.position.x < -W/2) { if(Math.abs(ball.position.z) < 8) goal('blue'); else ball.userData.vx *= -1; }
    if(Math.abs(ball.position.z) > H/2) ball.userData.vz *= -1;

    // C√°mara din√°mica
    camera.position.lerp(new THREE.Vector3(player.position.x - Math.sin(player.rotation.y)*15, 12, player.position.z - Math.cos(player.rotation.y)*15), 0.1);
    camera.lookAt(player.position.x, 2, player.position.z);

    renderer.render(scene, camera);
  }
  animate();
}
</script>
</body>
</html>
